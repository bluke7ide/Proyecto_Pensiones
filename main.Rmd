---
title: "Proyecto - Pensiones I"
author: 
  - Luis Fernando Amey Apuy - C20470
  - Javier Hernández Navarro - C13674
  - Anthony Mauricio Jiménez Navarro - C24067
  - Gustavo Alberto Amador Fonseca - C20459
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    highlight: tango
---
# Librerías e importaciones
```{r, warning=FALSE, message=FALSE}
source("cod/setup.R")
source("cod/load_database.R")
```

# Tomar los trabajadores activos
```{r}
ultimo_año <- data.frame(activo = rowSums(BD_Cotizantes %>%
                                select(tail(names(.), 12)) > 0)>0)
```

# Gráficos de CDR
## Estructura de la población
```{r}
cotizantes <- BD_Cotizantes %>% 
  select(2,3) %>% 
  mutate(estado = ultimo_año$activo)
pensionados <- BD_Pensionados %>% 
  select(4,5) %>% 
  mutate(estado = 2)
names(pensionados) <- names(cotizantes)
poblacion <- rbind(cotizantes, pensionados) %>% 
  mutate(edad = 2024 - year(Fec.Nac)) %>% 
  select(-1)
names(poblacion) <- tolower(names(poblacion))
poblacion[poblacion$sexo == "1",]$sexo <- "M"
poblacion[poblacion$sexo == "2",]$sexo <- "F"
cotizantes <- poblacion[1:5196,]
pensionados <- poblacion[5197:5561,]
```

```{r}
# Crear grupos de edad
df <- poblacion %>%
  mutate(grupo_edad = cut(
    edad,
    breaks = seq(0, 100, by = 5),
    right = FALSE,
    labels = paste(seq(0, 95, by = 5), seq(4, 99, by = 5), sep = "-")
  ))

# Agrupar por grupo de edad y sexo
df_piramide <- df %>%
  group_by(grupo_edad, sexo) %>%
  summarise(poblacion = n(), .groups = "drop") %>%
  mutate(poblacion = ifelse(sexo == "M", -poblacion, poblacion))

fig <- ggplot(df_piramide, aes(x = grupo_edad, y = poblacion, fill = sexo)) +
  geom_bar(stat = "identity", width = 0.9) +
  coord_flip() +
  scale_y_continuous(
    labels = abs,
    limits = c(-1, 1) * max(abs(df_piramide$poblacion))
  ) +
  labs(
    x = "Grupo de Edad",
    y = "Población",
    fill = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
  )

# ggsave("res/piramide.pdf", fig)


```

```{r}
df <- poblacion %>%
  mutate(
    sexo = recode(sexo, "M" = "Hombre", "F" = "Mujer"),
    estado = recode_factor(
      as.character(estado),
      "1" = "Activo",
      "0" = "No activo",
      "2" = "Pensionado"
    )
  )

# Agrupación por sexo
sexo_df <- df %>%
  count(categoria = sexo) %>%
  mutate(grupo = "Sexo")

# Agrupación por estado
estado_df <- df %>%
  count(categoria = estado) %>%
  mutate(grupo = "Estado")

resumen <- bind_rows(sexo_df, estado_df)

colores <- c(
  "Hombre" = "#377EB8",
  "Mujer" = "#984EA3",
  "Activo" = "#4DAF4A",
  "No activo" = "#FF7F00",
  "Pensionado" = "#999999"
)


fig <- ggplot(resumen, aes(x = grupo, y = n, fill = categoria)) +
  geom_bar(stat = "identity", position = "stack", width = 0.6) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "black", size = 4) +
  scale_fill_manual(values = colores) +
  labs(
    x = NULL,
    y = "Cantidad de Personas",
    fill = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(size = 12),
    legend.position = "right"
  )

# ggsave("res/resumen_pob.pdf", fig)

```

## Población activa
```{r}
cotizantes_activos <- cotizantes[cotizantes$estado == 1, ]

bar_totals <- cotizantes_activos %>%
  count(edad) %>%
  mutate(
    mitad = n / 2,
    edad = factor(edad)  
  )


fig <- ggplot(cotizantes_activos, aes(x = factor(edad), fill = sexo)) +
  geom_bar(position = "stack") +
  # Línea horizontal en la mitad de cada barra
  geom_segment(
    data = bar_totals,
    aes(x = edad, xend = edad, y = mitad - 0.5, yend = mitad + 0.5),
    inherit.aes = FALSE,
    color = "black",
    linewidth = 3
  ) +
  scale_x_discrete(
  breaks = as.character(seq(min(cotizantes_activos$edad), max(cotizantes_activos$edad), by = 5))
  ) +
  labs(
    x = "Edad",
    y = "Cantidad de cotizantes activos"
  ) +
  theme_minimal() 

# ggsave("res/dist_activos.pdf", fig)
```


```{r}
cotizantes <- cotizantes %>% 
  mutate(antiguedad = apply(BD_Cotizantes[, 4:ncol(BD_Cotizantes)], 1, function(x) which(x != 0)[1]))
cotizantes$antiguedad <- 2024 - year(as_datetime(names(BD_Cotizantes)[cotizantes$antiguedad+3]))
```

```{r}
fig <- ggplot(cotizantes, aes(x = antiguedad, fill = sexo)) + 
  geom_bar(position = "stack") +
  labs(
    x = "Años de antiguedad en el régimen",
    y = "Cantidad de personas"
  ) +
  theme_minimal()

# ggsave("res/activos_ant.pdf", fig)
```


## Población pensionada
```{r}
bar_totals <- pensionados %>%
  count(edad) %>%
  mutate(
    mitad = n / 2,
    edad = factor(edad) 
  )

fig <- ggplot(pensionados, aes(x = factor(edad), fill = sexo)) +
  geom_bar(position = "stack") +
  scale_x_discrete(
  breaks = as.character(seq(min(pensionados$edad), max(pensionados$edad), by = 5))
  ) +
  labs(
    x = "Edad",
    y = "Cantidad de cotizantes activos"
  ) +
  theme_minimal() 
# ggsave("res/dist_pensionados.pdf", fig)
```

```{r}
pensionados <- pensionados %>% 
  mutate(antiguedad = 2024 - year(BD_Pensionados$`Rige de la Pensión`))
fig <- ggplot(pensionados, aes(x = antiguedad, fill = sexo)) + 
  geom_bar(position = "stack") +
  labs(
    x = "Años pensionado",
    y = "Cantidad de pensionados"
  ) +
  theme_minimal() 
# ggsave("res/pensionados_ant.pdf", fig)
```

## Comportamiento de altas y bajas de afiliados
```{r}
n_meses <- ncol(BD_Cotizantes) - 3

# cuántas ventanas de 12 meses podemos formar
n_periodos <- n_meses - 12 + 1
if(n_periodos < 1) stop("¡No hay suficientes meses para formar un año completo!")

# Preparamos un objeto para guardar los indicadores
activo <- matrix(0L, 
                 nrow = nrow(BD_Cotizantes), 
                 ncol = n_periodos)

# Recorremos cada “ventana” de 12 meses
for(k in seq_len(n_periodos)){
  cols_k <- (3 + k):(3 + k + 11)    # e.g. para k=1, cols 4:15; para k=2, 5:16; etc.
  submat  <- BD_Cotizantes[, cols_k]
  
  # fila i = 1 si en esos 12 meses hubo al menos 1 >0
  activo[, k] <- as.double(rowSums(submat > 0) > 0)
}

# Ponemos nombres a cada periodo (opcional)
colnames(activo) <- colnames(BD_Cotizantes)[15:363]

# Finalmente, volcamos en comportamientos
# (aquí asumo que quieres mantener las 3 primeras columnas y luego estos indicadores)
comportamientos <- cbind(
  BD_Cotizantes[, 1:3],
  as.data.frame(activo)
)
```

```{r}
afiliados <- data.frame(fecha = colnames(BD_Cotizantes)[15:363], activos = colSums(activo))
fig <- ggplot(afiliados, aes(x = fecha, y = activos)) + 
  scale_x_discrete(breaks = afiliados$fecha[seq(1, nrow(afiliados), by = 60)]) +
  geom_point(color = 'purple') +
    labs(
    x = "Fecha",
    y = "Cantidad de afiliados"
  ) +
  theme_minimal() 
# ggsave("res/comportamiento.pdf", fig)
```

```{r}
diffs <- activo[, -1, drop = FALSE] - activo[, -ncol(activo), drop = FALSE]

Altas     <- colSums(diffs ==  1)  # pasó de 0 a 1
Bajas     <- colSums(diffs == -1)  # pasó de 1 a 0

resultado <- data.frame(
  fecha     = colnames(BD_Cotizantes)[16:363],
  Altas     = Altas,
  Bajas     = Bajas,
  Afiliados = colSums(activo)[2:349],
  row.names = NULL
)

```

```{r}
rm(activo,
   afiliados, 
   bar_totals,
   comportamientos,
   cotizantes,
   cotizantes_activos,
   df,
   df_piramide,
   diffs,
   estado_df, 
   fig,
   pensionados,
   poblacion,
   resultado,
   resumen,
   sexo_df,
   submat,
   Altas, 
   Bajas, 
   colores,
   cols_k,
   k,
   n_meses,
   n_periodos)
```

# Preparación Balance
## Población general
```{r}
cotizantes <- BD_Cotizantes %>% select(Fec.Nac, Sexo)
names(cotizantes) <- c('fecha_nac', 'sexo')
pensionados <- BD_Pensionados %>% select(FEC_NAC, SEXO)
names(pensionados) <- c('fecha_nac', 'sexo')
pensionados <- pensionados  %>%
  mutate(sexo = ifelse(sexo == "M", 1, 2))
poblacion <- rbind(cotizantes, pensionados) 
poblacion <- poblacion %>% mutate(
  edad = 2024 - year(poblacion$fecha_nac)
)
cuentas <- poblacion %>% count(sexo,edad)
unicos <- cuentas %>% select(sexo, edad)
```

```{r}
pensionados <- pensionados %>% mutate(
  edad = 2024 - year(pensionados$fecha_nac),
  meses = 12 - month(pensionados$fecha_nac)
)
cotizantes <- cotizantes %>% mutate(
  edad = 2024 - year(cotizantes$fecha_nac),
  meses = 12 - month(cotizantes$fecha_nac)
)
cotizaciones <- BD_Cotizantes %>% select(-1,-2,-3)
pensionados <- cbind(pensionados, BD_Pensionados) 
pensionados <- pensionados %>% select(-c(4,7,8))
pensionados <- pensionados %>% mutate(
  edad = 2024 - year(pensionados$fecha_nac)
)

niveles <- 110.39017/IPC$Nivel[229:588]
```



```{r}
rm(BD_Cotizantes,
   BD_Pensionados,
   BD_Financiero,
   ultimo_año,
   poblacion, 
   IPC, 
   cuentas
   )
```

## Propiedades de cotización
```{r}
cot_prop <- function(){
  # Tomando el valor presente
  vp_cot <- sapply(1:ncol(cotizaciones), function(x) t(cotizaciones[,x]) * niveles[[x]])
  
  # Salarios más de 10 mil cuentan como cotizaciones
  data <- vp_cot > 10000
  does_cot <- sapply(1:nrow(data), function(x) which(data[x,]))
  inicios <- sapply(1:nrow(data), function(x) first(does_cot[[x]]))
  
  # Cantidad de cuotas
  cuotas <- rowSums(data)
  
  # Densidades de cotización
  dens_cot <- sapply(1:nrow(data), function(x) 
    mean(data[x,inicios[x]:ncol(data)]))
  
  # Promedio de los 300 mejores salarios
  cot_pen <- vp_cot < 5e6
  
    # a menos de que históricamente haya cotizado 5m, se veta
  true_counts <- rowSums(1 - cot_pen)/cuotas > 0.5 # al menos más de la mitad 
  cot_pen[true_counts,] <- TRUE
  
    # Se fusionan las condiciones
  cot_pen <- cot_pen & data
  calc_pen <- sapply(1:nrow(data), function(x) vp_cot[x, cot_pen[x,]])
  
    # Cálculo explícito
  Sx <- sapply(1:nrow(data), function(x) 
    mean(head(sort(calc_pen[[x]], decreasing = T), 300)))
  
  return(data.frame(densidades = dens_cot, sal_prom = Sx, cuotas = cuotas))
}
```

```{r}
cotizantes <- cbind(cotizantes, cot_prop())
```

## Cantidad de las cuotas de los cotizantes
```{r}
cuotas <- data.frame( # Se hacen 60 años para tener 16 decimales de exactitud, 
  # minimo es 21 + 60 - 65 = 16 años después de la edad requerida
  sapply(0:60, function(x) cotizantes$densidades*x*12 + cotizantes$cuotas))
names(cuotas) <- 0:60 + 2024
```


```{r}
find_qx <- function(x, sexo, año){
  return(SUPEN[which(SUPEN$sex == sexo & SUPEN$year == año & SUPEN$edad == x),6])
}

all_qx <- function(x, sexo, año){
  return(sapply(0:(115-x), function(y) find_qx(x+y, 1,año + y)))
}

# all_tpx <- function(x, sexo, año){
#   qx <- find_life(x, sexo, año)
#   return(cumprod(1 - qx[-length(qx)]))
# }
# 
# all_deaths <- function(x, sexo, año){
#   qx <- find_life(x, sexo, año)
#   tpx <- cumprod(c(1, 1 - qx[-length(qx)]))
#   return(tpx*qx)
# }
```

```{r}
find_qix <- function(x, sexo, año){
  return(invalidez[invalidez$Edad == x & invalidez$sexo == sexo, 3])
}

all_qix <- function(x, sexo, año){
  return(sapply(0:(115-x), function(y) find_qix(x+y, 1,año + y)))
}

# all_tpix <- function(x, sexo, año){
#   qix <- find_inv(x, sexo, año)
#   return(cumprod(1 - qix[-length(qix)]))
# }
# 
# all_inv <- function(x, sexo, año){
#   qix <- find_inv(x, sexo, año)
#   tpix <- cumprod(c(1, 1 - qix[-length(qix)]))
#   return(tpix*qix)
# }

```


```{r}
año <- 2025
cot_min_inv <- function(x) 12 + min(max(x-24, 0), 18)*4 + min(max(0, x-42), 6)*6

sapply(0:115, cot_min_inv)
```


```{r}
porc_pensiones <- function(id){
  # Preliminares
  x <- cotizantes$edad[id]
  sexo <- cotizantes$sexo[id]
  dens <- cotizantes$densidades[id]
  rango <- 1:min(61,(115-x))
  n_cot <- unlist(cuotas[id,rango])
  qx <- all_qx(x, sexo, año)
  px <- 1 - qx
  v_px <- 1 - all_qx(x, sex_con, año)
  qix <- all_qix(x, sexo, año)
  pix <- 1 - qix
  sim <- data.frame(act = rep(0, 116-x),
                    inv = 0,
                    pen = 0,
                    surv = 0,
                    viudez = 0,
                    orph = 0)
  sim[1,1] <- 1
  sim[1,4] <- 1
  
  
  
  # Porcentajes conyuge
  sex_con <- 3 - sexo
    if(x < 50){
    porc_viu <- c(rep(0.5, 50-x), rep(0.6, 10), rep(0.7, 115-60))
  } else if(x < 60){
    porc_viu <- c(rep(0.6, 60-x), rep(0.7, 115-60))
  } else {
    porc_viu <- c(rep(0.7, 115-x))
  }
  
  # Si aplica al hijo, o si no ha nacido
  cond_hij <- x-25 < 25 & x-25 >=0
  if(cond_hij){
      o_px <- 1 - 0.5*(all_qx(x-25, 1, año) + all_qx(x-25, 2, año))
  }
  
  # Condición y porcentajes para pensionarse

  cond_pen <- n_cot >= 300 & x+rango >= 65
  porc_pen <- as.double(cond_pen)
  ini_pen <- which(cond_pen)[1]
  if(sexo == 2){
    if(x <= 64){
      cond_pen[65-x] <- n_cot[65-x] >= 357
      if(cond_pen[65-x]){
        
      }
    }
    if(x <= 63){
      cond_pen[64-x] <- n_cot[64-x] >= 405
      if(cond_pen[65-x]){
        
      }
    }
  }
  
  # Condiciones de cuotas de pensiones
  req_invp <- sapply(x+rango, cot_min_inv)
  ncot180 <- n_cot >= 180
  cond_penp <- ncot180 & x+rango >= 65
  cond_inv <- ncot180 | (dens > 0.5 &  req_invp < n_cot) 
  cond_invp <- n_cot >= 60 & dens > 0.5
  cond_tras <- ncot180 | dens > 0.5
  
  
  
  # Se realiza una tabla acumulativa
  for(i in 1:(115-x)){
    sim[i+1,1] <- sim[i,1]*px[i]*pix[i]
    if(i < length(rango)){
      # Invalidez
      if(cond_inv[i]){
        sim[i+1,2] <- sim[i,1]*px[i]*qix[i] + sim[i,2]*px[i]
      # Si no se pudo normal, entonces pruebe proporcional
      } else if(cond_invp[i]){
        sim[i+1,2] <- sim[i,1]*px[i]*qix[i]*n_cot[i]/req_invp[i] + sim[i,2]*px[i]
      }
      
      # Vejez
      if(cond_pen[i]){
        # probabilidad de retiro, calcular % y multiplicar acá
        sim[i+1,3] <- sim[i,3]*px[i] + sim[i,1]*0.9*px[i] 
        sim[i+1,1] <- sim[i+1,1]*0.1
        
      } else if(cond_penp[i]){
        sim[i+1,3] <- sim[i,3]*px[i] + sim[i,1]*0.9*px[i]
        sim[i+1,1] <- sim[i+1,1]*0.1
        # postergación en proporcion?
      }
    } else {
      sim[i+1,2] <- sim[i,2]*px[i]
      sim[i+1,3] <- sim[i,3]*px[i]
    }
    
    sim[i+1,4] <- sim[i+1,2] + sim[i+1,3]
    # Sucesión
    sim[i+1,5] <- sim[i,5]*v_px[i]+sim[i,4]*qx[i]
    if(cond_hij){
      if(x-25+i > 25){
        cond_hij <- F
      } else {
        sim[i+1,6] <- sim[i,6]*o_px[i] + sim[i,4]*qx[i]
      }
    }
  }
  sim[,2] <- sim[,2]*c(0,porc_viu)
  sim[,3] <- sim[,3]*0.3
  return(sim)
}
```

```{r}
# debug(porc_pensiones)

persona <- porc_pensiones(3587)
View(persona)
```




```{r}
prueba <- function(int, inf){
  int_ef <- ((1+int)/(1+inf))^(-1/12) 
  years <- 0:95 + 2024
  cot_hombres <- cotizantes[cotizantes$sexo == 1, ] %>% select(-2)
  cot_mujeres <- cotizantes[cotizantes$sexo == 2, ] %>% select(-2)
  pen_hombres <- pensionados[pensionados$sexo == 1, ] %>% select(-2)
  pen_mujeres <- pensionados[pensionados$sexo == 2, ] %>% select(-2)
  
}
```
























