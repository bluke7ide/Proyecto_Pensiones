---
title: "Proyecto - Pensiones I"
author: 
  - Luis Fernando Amey Apuy - C20470
  - Javier Hernández Navarro - C13674
  - Anthony Mauricio Jiménez Navarro - C24067
  - Gustavo Alberto Amador Fonseca - C20459
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    highlight: tango
---
# Librerías e importaciones
```{r, warning=FALSE, message=FALSE}
source("cod/setup.R")
source("cod/load_database.R")
```

# Tomar los trabajadores activos
```{r}
ultimo_año <- data.frame(activo = rowSums(BD_Cotizantes %>%
                                select(tail(names(.), 12)) > 0)>0)
```

# Gráficos de CDR
## Estructura de la población
```{r}
cotizantes <- BD_Cotizantes %>% 
  select(2,3) %>% 
  mutate(estado = ultimo_año$activo)
pensionados <- BD_Pensionados %>% 
  select(4,5) %>% 
  mutate(estado = 2)
names(pensionados) <- names(cotizantes)
poblacion <- rbind(cotizantes, pensionados) %>% 
  mutate(edad = 2024 - year(Fec.Nac)) %>% 
  select(-1)
names(poblacion) <- tolower(names(poblacion))
poblacion[poblacion$sexo == "1",]$sexo <- "M"
poblacion[poblacion$sexo == "2",]$sexo <- "F"
cotizantes <- poblacion[1:5196,]
pensionados <- poblacion[5197:5561,]
```

```{r}
# Crear grupos de edad
df <- poblacion %>%
  mutate(grupo_edad = cut(
    edad,
    breaks = seq(0, 100, by = 5),
    right = FALSE,
    labels = paste(seq(0, 95, by = 5), seq(4, 99, by = 5), sep = "-")
  ))

# Agrupar por grupo de edad y sexo
df_piramide <- df %>%
  group_by(grupo_edad, sexo) %>%
  summarise(poblacion = n(), .groups = "drop") %>%
  mutate(poblacion = ifelse(sexo == "M", -poblacion, poblacion))

fig <- ggplot(df_piramide, aes(x = grupo_edad, y = poblacion, fill = sexo)) +
  geom_bar(stat = "identity", width = 0.9) +
  coord_flip() +
  scale_y_continuous(
    labels = abs,
    limits = c(-1, 1) * max(abs(df_piramide$poblacion))
  ) +
  labs(
    x = "Grupo de Edad",
    y = "Población",
    fill = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
  )

# ggsave("res/piramide.pdf", fig)


```

```{r}
df <- poblacion %>%
  mutate(
    sexo = recode(sexo, "M" = "Hombre", "F" = "Mujer"),
    estado = recode_factor(
      as.character(estado),
      "1" = "Activo",
      "0" = "No activo",
      "2" = "Pensionado"
    )
  )

# Agrupación por sexo
sexo_df <- df %>%
  count(categoria = sexo) %>%
  mutate(grupo = "Sexo")

# Agrupación por estado
estado_df <- df %>%
  count(categoria = estado) %>%
  mutate(grupo = "Estado")

resumen <- bind_rows(sexo_df, estado_df)

colores <- c(
  "Hombre" = "#377EB8",
  "Mujer" = "#984EA3",
  "Activo" = "#4DAF4A",
  "No activo" = "#FF7F00",
  "Pensionado" = "#999999"
)


fig <- ggplot(resumen, aes(x = grupo, y = n, fill = categoria)) +
  geom_bar(stat = "identity", position = "stack", width = 0.6) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "black", size = 4) +
  scale_fill_manual(values = colores) +
  labs(
    x = NULL,
    y = "Cantidad de Personas",
    fill = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(size = 12),
    legend.position = "right"
  )

# ggsave("res/resumen_pob.pdf", fig)

```

## Población activa
```{r}
cotizantes_activos <- cotizantes[cotizantes$estado == 1, ]

bar_totals <- cotizantes_activos %>%
  count(edad) %>%
  mutate(
    mitad = n / 2,
    edad = factor(edad)  
  )


fig <- ggplot(cotizantes_activos, aes(x = factor(edad), fill = sexo)) +
  geom_bar(position = "stack") +
  # Línea horizontal en la mitad de cada barra
  geom_segment(
    data = bar_totals,
    aes(x = edad, xend = edad, y = mitad - 0.5, yend = mitad + 0.5),
    inherit.aes = FALSE,
    color = "black",
    linewidth = 3
  ) +
  scale_x_discrete(
  breaks = as.character(seq(min(cotizantes_activos$edad), max(cotizantes_activos$edad), by = 5))
  ) +
  labs(
    x = "Edad",
    y = "Cantidad de cotizantes activos"
  ) +
  theme_minimal() 

# ggsave("res/dist_activos.pdf", fig)
```

```{r}
cotizantes <- cotizantes %>% 
  mutate(antiguedad = apply(BD_Cotizantes[, 4:ncol(BD_Cotizantes)], 1, function(x) which(x != 0)[1]))
cotizantes$antiguedad <- 2024 - year(as_datetime(names(BD_Cotizantes)[cotizantes$antiguedad+3]))
```

```{r}
fig <- ggplot(cotizantes, aes(x = antiguedad, fill = sexo)) + 
  geom_bar(position = "stack") +
  labs(
    x = "Años de antiguedad en el régimen",
    y = "Cantidad de personas"
  ) +
  theme_minimal()

# ggsave("res/activos_ant.pdf", fig)
```

## Población pensionada
```{r}
bar_totals <- pensionados %>%
  count(edad) %>%
  mutate(
    mitad = n / 2,
    edad = factor(edad) 
  )

fig <- ggplot(pensionados, aes(x = factor(edad), fill = sexo)) +
  geom_bar(position = "stack") +
  scale_x_discrete(
  breaks = as.character(seq(min(pensionados$edad), max(pensionados$edad), by = 5))
  ) +
  labs(
    x = "Edad",
    y = "Cantidad de cotizantes activos"
  ) +
  theme_minimal() 
# ggsave("res/dist_pensionados.pdf", fig)
```

```{r}
pensionados <- pensionados %>% 
  mutate(antiguedad = 2024 - year(BD_Pensionados$`Rige de la Pensión`))
fig <- ggplot(pensionados, aes(x = antiguedad, fill = sexo)) + 
  geom_bar(position = "stack") +
  labs(
    x = "Años pensionado",
    y = "Cantidad de pensionados"
  ) +
  theme_minimal() 
# ggsave("res/pensionados_ant.pdf", fig)
```

## Comportamiento de altas y bajas de afiliados
```{r}
n_meses <- ncol(BD_Cotizantes) - 3

# cuántas ventanas de 12 meses podemos formar
n_periodos <- n_meses - 12 + 1
if(n_periodos < 1) stop("¡No hay suficientes meses para formar un año completo!")

# Preparamos un objeto para guardar los indicadores
activo <- matrix(0L, 
                 nrow = nrow(BD_Cotizantes), 
                 ncol = n_periodos)

# Recorremos cada “ventana” de 12 meses
for(k in seq_len(n_periodos)){
  cols_k <- (3 + k):(3 + k + 11)    # e.g. para k=1, cols 4:15; para k=2, 5:16; etc.
  submat  <- BD_Cotizantes[, cols_k]
  
  # fila i = 1 si en esos 12 meses hubo al menos 1 >0
  activo[, k] <- as.double(rowSums(submat > 0) > 0)
}

# Ponemos nombres a cada periodo (opcional)
colnames(activo) <- colnames(BD_Cotizantes)[15:363]

# Finalmente, volcamos en comportamientos
# (aquí asumo que quieres mantener las 3 primeras columnas y luego estos indicadores)
comportamientos <- cbind(
  BD_Cotizantes[, 1:3],
  as.data.frame(activo)
)
```

```{r}
afiliados <- data.frame(fecha = colnames(BD_Cotizantes)[15:363], activos = colSums(activo))
fig <- ggplot(afiliados, aes(x = fecha, y = activos)) + 
  scale_x_discrete(breaks = afiliados$fecha[seq(1, nrow(afiliados), by = 60)]) +
  geom_point(color = 'purple') +
    labs(
    x = "Fecha",
    y = "Cantidad de afiliados"
  ) +
  theme_minimal() 
# ggsave("res/comportamiento.pdf", fig)
```

```{r}
diffs <- activo[, -1, drop = FALSE] - activo[, -ncol(activo), drop = FALSE]

Altas     <- colSums(diffs ==  1)  # pasó de 0 a 1
Bajas     <- colSums(diffs == -1)  # pasó de 1 a 0

resultado <- data.frame(
  fecha     = colnames(BD_Cotizantes)[16:363],
  Altas     = Altas,
  Bajas     = Bajas,
  Afiliados = colSums(activo)[2:349],
  row.names = NULL
)

```

```{r}
rm(activo,
   afiliados, 
   bar_totals,
   comportamientos,
   cotizantes,
   cotizantes_activos,
   df,
   df_piramide,
   diffs,
   estado_df, 
   fig,
   pensionados,
   poblacion,
   resultado,
   resumen,
   sexo_df,
   submat,
   Altas, 
   Bajas, 
   colores,
   cols_k,
   k,
   n_meses,
   n_periodos, 
   invalidez)
```

# Preparación Balance
## Población general
```{r}
cotizantes <- BD_Cotizantes %>% select(Fec.Nac, Sexo)
names(cotizantes) <- c('fecha_nac', 'sexo')
pensionados <- BD_Pensionados %>% select(FEC_NAC, SEXO)
names(pensionados) <- c('fecha_nac', 'sexo')
pensionados <- pensionados  %>%
  mutate(sexo = ifelse(sexo == "M", 1, 2))
poblacion <- rbind(cotizantes, pensionados) 
poblacion <- poblacion %>% mutate(
  edad = 2024 - year(poblacion$fecha_nac)
)
cuentas <- poblacion %>% count(sexo,edad)
unicos <- cuentas %>% select(sexo, edad)
```

```{r}
pensionados <- pensionados %>% mutate(
  edad = 2024 - year(pensionados$fecha_nac),
  meses = 12 - month(pensionados$fecha_nac)
)
cotizantes <- cotizantes %>% mutate(
  edad = 2024 - year(cotizantes$fecha_nac),
  meses = 12 - month(cotizantes$fecha_nac)
)
cotizaciones <- BD_Cotizantes %>% select(-1,-2,-3)
pensionados <- cbind(pensionados, BD_Pensionados) 
pensionados <- pensionados %>% select(-c(4,7,8))
pensionados <- pensionados %>% mutate(
  edad = 2024 - year(pensionados$fecha_nac)
)

niveles <- 110.39017/IPC$Nivel[229:588]
```

## Funciones alternas
```{r, message=FALSE}
source("cod/curva_dens.R")
source("cod/curva_salarial.R")
source("cod/vp_pen_futuras.R")
```

### Curva salarial
```{r}
curv_sal <- curva_salarial$s_x
plot(cumprod(curv_sal))
```

### Propiedades de cotizaciones
```{r}
cotizantes <- cbind(cotizantes, cot_prop())
```

### Curva de densidades de cotizacion
```{r}
curv_dens <- curva_densidad$media
plot(curv_dens)
```

### Obtención de matrices de probabilidad de muerte
```{r}
find_qx <- function(x, sexo, año){
  return(SUPEN[which(SUPEN$sex == sexo & SUPEN$year == año & SUPEN$edad == x),6])
}
año <- 2025
t <- proc.time()
all_qx <- list(
  sapply(0:95, function(y) sapply(0:115, function(x) find_qx(x, 1, año+y))),
  sapply(0:95, function(y) sapply(0:115, function(x) find_qx(x, 2, año+y))))
proc.time() - t
```

### Precálculo de las pensiones
```{r}
t <- proc.time()
pensiones <- list()
for(id in 1:5196){
  pensiones[[id]] <- sal_pen(cotizantes$edad[id],
                             cotizantes$cuotas[id],
                             cotizantes$sal_prom[id],
                             cotizaciones[id,])
}
proc.time() - t
```

### Obtención del interés
```{r}
hoja <- BD_Financiero[[3]]
int_mes <- sapply(1:120, function(x)  (hoja[x+1, 2] - hoja[x,2] - hoja[x,4] + hoja[x,5])/(hoja[x,2] + (hoja[x,4] - hoja[x,5])/2)+1)
int_mes <- unlist(int_mes)
int <- sapply(1:109, function(x) prod(int_mes[x:(11+x)])-1)
inf_max <- IPC$Nivel[564]/IPC$Nivel[552] - 1
plot(int)
lines((0:109)*-0.0003859 + 0.177)
```

```{r}
(int_real <- mean(int) - inf_max)
```

```{r}
rm(BD_Cotizantes,
   BD_Pensionados,
   BD_Financiero,
   ultimo_año,
   poblacion, 
   IPC, 
   cuentas, 
   cot_prop,
   curva_salarial,
   curva_dens, 
   SUPEN,
   unicos, 
   find_qx, 
   hoja,
   int, 
   inf_max, 
   int_mes, 
   sal_pen
   )
```

# Balance Actuarial
## Cálculo del VP de beneficios de pensiones futuras
```{r}
t <- proc.time()
datos <- vp_pen_futuras(int_real, 0.02)/1e9
proc.time() - t
```

```{r}
rowSums(datos)[1:4]
```



# desde 0 >:(
```{r}
qx <- sapply(0:95, function(x) all_qx[[1]][21+x, 1+x])
px <- 1-qx
qi <- all_qix[[1]][1:96]
pi <- 1-pi
tpx <- c(1,cumprod(px))
open <- qx*tpx
vqx <- sapply(0:95, function(x) all_qx[[2]][21+x, 1+x])
```

## Objetivo
calcular las pensiones por anualidades de mortalidad, en la función traerlas a vp

## Pensión por invalidez a edad $x \in [20, 115]$
```{r}
pen_inv <- function(){
  w <- 115
  pen_inv <- list()
  for(sex in 1:2){
    inv <- list()
    for(x in 20:w){
      res <- (w-x+1)
      px <- 1-sapply(1:res, function(y) all_qx[[sex]][x+y, y]) # por si acaso, 
      # la edad es una más en la tabla all_qx
      qi <- all_qix[[1]][1:res]
      pi <- 1-qi
      tpx <- cumprod(px)
      tpix <- c(1,cumprod(pi)[-res]) # prioridad de invalidez sobre retiro
      vida <- sapply(1:res, function(x) c(tpix[0:(x-1)], rep(qi[x]*tpix[x], res-x+1)))
      vida <- t(vida*tpx)
      diag(vida) <- diag(vida)
      inv[[x-19]] <- vida
    }
    pen_inv[[sex]] <- inv
  }
  return(pen_inv)
}
```

```{r}
inv <- pen_inv()
```

## Pensión por vejez a edad $x \in [20, 115]$
Como depende del individuo, se calculan todos los posibles casos de pensión por edad por sexo

```{r}
sob_vej <- function(){
  w <- 115
  pen <- list()
  for(sex in 1:2){
    ret <- list()
    for(x in 20:w){
      res <- (w-x+1)
      px <- 1-sapply(1:res, function(y) all_qx[[sex]][x+y, y])
      pi <- 1-all_qix[[1]][1:res]
      tpx <- cumprod(px)
      tpix <- cumprod(pi) # prioridad invalidez sobre retiro
      vida <- t(sapply(1:res, function(x) c(tpix[1:x], rep(tpix[x], res-x))*tpx))
      ret[[x-19]] <- vida
    }
    pen[[sex]] <- ret
  }
  return(pen)
}
```

```{r}
pen <- sob_vej()
```

## Pensión por viudez a edad $x \in [20, 115]$
```{r}
pen_viu <- function(){
  w <- 115
  pen_viu <- list()
  for(sex in 1:2){
    viu <- list()
    for(x in 20:w){
      res <- (w-x+1)
      if(x < 50){
        porc_viu <- c(rep(0.5, 50-x), rep(0.6, 10), rep(0.7, w+1-60))
      } else if(x < 60){
        porc_viu <- c(rep(0.6, 60-x), rep(0.7, w+1-60))
      } else {
        porc_viu <- c(rep(0.7, res))
      }
      vpx <- 1 - sapply(1:res, function(y) all_qx[[3-sex]][x+y, y])
      vtpx <- cumprod(vpx)
      vida <- t(sapply(1:res, function(x) c(rep(0, x-1), vtpx[x:res])*porc_viu))
      viu[[x-19]] <- vida
    }
    pen_viu[[sex]] <- viu
  }
  return(pen_viu)
}
```

```{r}
viu <- pen_viu()
```

## Pensión por orfandad a edad $x \in [20, 115]$
```{r}
pen_orf <- function(){
  w <- 115
  pen_orf <- list()
  for(sex in 1:2){
    orf <- list()
    for(x in 20:49){
      res <- (w-x+1)
      if(x < 25){
        porc_orf <- c(rep(0, 25-x), rep(0.3, 25), rep(0, res+x-50))
      } else if(x<50){
        porc_orf <- c(rep(0.3, 50-x), rep(0, res-50+x))
      } else {
        orf[[x-19]]  <- rep(0, res)
        next
      }

      opx <- 1 - (sapply(1:res, function(y) all_qx[[1]][x+y, y]) + 
                    sapply(1:res, function(y) all_qx[[2]][x+y, y]))/2
      otpx <- cumprod(opx)
      vida <- t(sapply(1:res, function(x) c(rep(0, x-1), otpx[x:res])*porc_orf))
      orf[[x-19]] <- vida
    }
    pen_orf[[sex]] <- orf
  }
  return(pen_orf)
}
```

```{r}
orf <- pen_orf()
```

## Precálculo de los qx

```{r}
pc_qx <- function(){
    w <- 115
  difsex <- list()
  for(sex in 1:2){
    tqx <- list()
    for(x in 20:w){
      res <- (w-x)
      qx <- sapply(1:res, function(y) all_qx[[sex]][x+y, y])
      tqx[[x-19]] <- qx
    }
    difsex[[sex]] <- tqx
  }
  return(difsex)
}
```

```{r}
qx <- pc_qx()
```


## Cálculo con pensiones precalculadas
### Función para leer sumas de columnas de matrices triangulares
```{r}
readt <- function(mat){
  return(sapply(1:ncol(mat), function(x) sum(mat[1:x,x])))
}
```

```{r}
vp_pen_fut <- function(int, inf){
  int_ef <- ((1+int)/(1+inf))
  anual <- (1 - int_ef^-1)/(int_ef^(1/12) -1)
  limit2 <- 2e6*int_ef^-(0:95)
  limit3.5 <- 3.5e6*int_ef^-(0:95)
  cot_min <- sapply(0:95, function(y) cotizacion_minima(20+y, 2)[1])
  edad_min <- sapply(0:95, function(y) cotizacion_minima(20+y, 2)[2])
  res <- data.frame(Inv = rep(0, 96), Pen = 0, Suc = 0, SEM = 0, Cot = 0)
  # Doble iteración para recorrer toda la data, individuos y años
  for(id in 1:5196){
    # Preliminares del individuo
    x <- cotizantes$edad[id]
    sexo <- cotizantes$sexo[id]
    cuota_ini <- cotizantes$cuotas[id]
    int_years <- 0:(115-x)
    vp_pen <- c(pensiones[[id]],0)*int_ef^(-int_years)
    ind_cot <- vp_pen > limit2[1:length(sal_pen)]
    
    temp <- vp_pen[ind_cot]
    vp_pen[ind_cot] <- temp*0.95
    cot_pen <- rep(0, length(vp_pen))
    cot_pen[ind_cot] <- temp*0.05
    n_cot <- cuota_ini + cumsum(curv_dens[(x-19)+int_years])

    if(sexo == 1){
      cond_pen <- n_cot >= 300 & x+int_years >= 65
    } else {
      cond_pen <- n_cot >= cot_min[int_years+1] & x+int_years >= edad_min[int_years+1]
    }
    ini_pen <- first(which(cond_pen))
    cot_ad <- (n_cot[ini_pen]-300)/1200 + 1
    porc_pen <- sapply(int_years+1, function(y) min(1.25,max(0,n_cot[y]-n_cot[ini_pen])*2/1500+cot_ad))
    
    # Inicialización del dataframe del individuo
    per <- data.frame(inv = rep(0,115-x+1), pen = 0, viu = 0, orf = 0, cotinv = 0, cotpen = 0, cotviu = 0, cotorf = 0)
    limit <- limit3.5[int_years+1]

    cot_pen[vp_pen > limit] <- cot_pen[vp_pen > limit] +
      vp_pen[vp_pen > limit] - limit[vp_pen > limit]
    vp_pen[vp_pen > limit] <- limit[vp_pen > limit]
    vp_pen <- vp_pen*(anual + int_ef^(-11/12))
    cot_pen <- cot_pen*(anual + int_ef^(-11/12))
    
    data_inv <- inv[[sexo]][[x-19]]
    cond_inv <- n_cot >= 180 | cot_min_inv(x+int_years)
    cond_invp <- (n_cot>=60)*n_cot/180
    data_pen <- pen[[sexo]][[x-19]]
    cond_penp <- (n_cot >= 180 & x+int_years >= 65)*n_cot/300
    
    # Condiciones de invalidez
    temp <- data_inv*(cond_inv + (!cond_inv & cond_invp))
    per$inv <- readt(temp*vp_pen)
    per$cotinv <- readt(temp*cot_pen)
    
    # Condiciones de vejez
    qr <- c(rep(0, ini_pen-1), (0.09)^(0:(115-x+1-ini_pen))*0.9)
    temp <- data_pen*(cond_pen*porc_pen + (!cond_pen * cond_penp))*qr
    per$pen <- readt(temp*vp_pen)
    per$cotpen <- readt(temp*cot_pen)

    # Condiciones de sucesión 
    mux <- qx[[sexo]][[x-20]]
    cond_suc <- (n_cot >= 180)*c(1,diag(data_pen)[-ncol(data_pen)])*mux*((n_cot >= 300)*porc_pen+(!n_cot >= 300)*n_cot/300)
    suc_pen <- (per$pen+per$inv)*mux +  cond_suc*vp_pen
    suc_cot <- (per$cotpen+per$cotinv)*mux +  cond_suc*cot_pen
    # no importa invalidez y muerte al mismo tiempo, entonces por eso el 1 al inicio. 
    # Los demás si para no contabilizar doble pensión
    per$viu <- readt(viu[[sexo]][[x-19]]*suc_pen)
    per$cotviu <- readt(viu[[sexo]][[x-19]]*suc_cot)
    if(x < 50){
      per$orf <- readt(orf[[sexo]][[x-19]]*suc_pen)
      per$cotorf <- readt(orf[[sexo]][[x-19]]*suc_cot)
    }
    # browser()
    
    res$Inv <- res$Inv + c(per$inv, rep(0, 95-(115-x)))
    res$Pen <- res$Pen + c(per$pen, rep(0, 95-(115-x)))
    res$Suc <- res$Suc + c(per$viu + per$orf, rep(0, 95-(115-x)))
    res$Cot <- res$Cot + c(per$cotinv+ per$cotpen + per$cotviu + per$cotorf, rep(0, 95-(115-x)))
  }
  res$SEM <- 0.085*anual*(res$Inv+res$Pen+res$Suc)/(anual + int_ef^(-11/12))
  
  return(t(res*int_ef^(-(1:96))))
}
```

```{r}
t <- proc.time()
datos <- vp_pen_fut(int_real, 0.02)/1e9
proc.time() - t
```

```{r}
rowSums(datos)[1:4]
```

Resultados similares pero diferentes -> Modelo estocástico

```{r}
curva_densidad$media <- curva_densidad$media/12
curva_densidad$std <- curva_densidad$std/12
```

```{r}
cotizaciones <- cotizaciones*niveles
cuotas <- list()
for(i in 1:5196){
  cuotas[[i]] <- sapply(26:30, function(x) sum(cotizaciones[i,1:12+(12*(x-1))] > 1e4))
}
```


```{r}
proy_est <- function(int, inf){
  v <- (1+inf)/(1+int)
  res <- data.frame(Inv = rep(0, 96), Pen = 0, Suc = 0, SEM = 0, Cot = 0)
  min_inv <- cot_min_inv(20:115)
  for(id in 1:5196){
    cuotas <- cuotas[id,]
    cuota <- cotizantes$cuotas[id]
    sexo <- cotizantes$sexo[id]
    x <- cotizantes$edad[id]
    estado <- 0
    px <- 1-qx[[sexo]][[x - 19]]
    vpx <- 1-qx[[3-sexo]][[x - 19]]
    pix <- 1-all_qix[[sexo]][(x-19):96]
    cuotas <- c(cuotas, rep(0, 95))
    first_pen <- T
    cotizaciones <- cotizaciones[id, cotizaciones[id,] > 10000]
    for(j in 1:(115-x)){
      cuotas[j+5] <- rbinom(1, 12, min(max(0, rnorm(1, curva_densidad$media[x+j-20],
                                       curva_densidad$std[x+j-20])),1)) 
      cuota <- cuota + cuotas[j+5]
        
      
      if(estado == 0){ # Trabaja
        if(runif(1) > px[j]){ # Muerte directa
          estado <- 3
        } else if(runif(1)>pix[j]){ # Invalidez
          porc_pen <- 1
          if(cuotas[j+1] >= 180){
            estado <- 2
          } else if(x + j < 48 & sum(cuotas[(j+3):(j+5)])>=12 & cuota > min_inv[x-19]){
            estado <- 2
          } else if(x + j >= 48 & sum(cuotas[(j+1):(j+5)])>=24 & cuota > min_inv[x-19]){
            estado <- 2
          } else if(cuota >= 60 & (sum(cuotas[(j+3):(j+5)])>=12|sum(cuotas[(j+1):(j+5)])>=24)){
            estado <- 2
            porc_pen <- cuota/180
          } else { # No hay pensión ni sucesoria, gracias por aportar
            next
          }
        } else { # sobrevive, e invalidez > retiro
          if(x >= 65 & cuota >= 300){
            roll_pen <- T
          } else if (sexo == 2 & x == 64 & cuota >= 357){
            roll_pen <- T
          } else if (sexo == 2 & x == 63 & cuota >= 405){
            roll_pen <- T
          } else if (x >= 65 & cuota >= 180 & runif(1) >= 0.9){
            estado <- 1
            porc_pen <- cuota/300
          }
          if(roll_pen){ # para ver si se retira
            roll_pen <- F
            if(first_pen){
              first_pen <- F
              ini_pen <- cuota
            }
            if(runif(1) >= 0.9){
              estado <- 1
              porc_pen <- min(1.25, 1 + (cuota-ini_pen)*2/1500 + (ini_pen-300)/1200)
            }
          }
        }
        if(estado == 1 | estado == 2){# Se acaba justo de pensionar
          # hay que 
          # 1. calcular la pensión y pagar por mitades de año (continuo)
          if(estado == 1){
            res$Pen[j] <- res$Pen[j] + sal_pen*v^j # definir 1.
          } else if(estado == 2) {
            res$Inv[j] <- res$Inv[j] + sal_pen*v^j # definir 1.
          }
        }
      } else if(estado == 1 | estado == 2){ # Pensionado
        if(runif(1) > px[j]){ # Muerte directa
          estado <- 3
        }
        # sigue un pago más
        if(estado == 1){
          res$Pen[j] <- res$Pen[j] + sal_pen*v^j # definir 1.
        } else if(estado == 2) {
          res$Inv[j] <- res$Inv[j] + sal_pen*v^j # definir 1.
        }
      }
      if(estado == 3){ # Muerto
        if(x-25 >=0){ # si hay un hijo
          
        }
      }
      
    }
  }
}
```






























