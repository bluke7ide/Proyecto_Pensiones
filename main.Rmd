---
title: "Proyecto - Pensiones I"
author: 
  - Luis Fernando Amey Apuy - C20470
  - Javier Hernández Navarro - C13674
  - Anthony Mauricio Jiménez Navarro - C24067
  - Gustavo Alberto Amador Fonseca - C20459
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    highlight: tango
---
# Librerías e importaciones
```{r, warning=FALSE, message=FALSE}
source("cod/setup.R")
source("cod/load_database.R")
```

# Gráficos de CDR
```{r}
source("cod/graficos.R")
```

```{r}
rm(activo,
   afiliados, 
   bar_totals,
   comportamientos,
   cotizantes,
   cotizantes_activos,
   df,
   df_piramide,
   diffs,
   estado_df, 
   fig,
   pensionados,
   poblacion,
   resultado,
   resumen,
   sexo_df,
   submat,
   Altas, 
   Bajas, 
   colores,
   cols_k,
   k,
   n_meses,
   n_periodos, 
   invalidez,
   ultimo_año)
```

# Preparación Balance
## Población general
```{r}
cotizantes <- BD_Cotizantes %>% select(Fec.Nac, Sexo)
names(cotizantes) <- c('fecha_nac', 'sexo')
pensionados <- BD_Pensionados %>% select(FEC_NAC, SEXO)
names(pensionados) <- c('fecha_nac', 'sexo')
pensionados <- pensionados  %>%
  mutate(sexo = ifelse(sexo == "M", 1, 2))
poblacion <- rbind(cotizantes, pensionados) 
poblacion <- poblacion %>% mutate(
  edad = 2024 - year(poblacion$fecha_nac)
)
cuentas <- poblacion %>% count(sexo,edad)
unicos <- cuentas %>% select(sexo, edad)
```

```{r}
pensionados <- pensionados %>% mutate(
  edad = 2024 - year(pensionados$fecha_nac),
  meses = 12 - month(pensionados$fecha_nac)
)
cotizantes <- cotizantes %>% mutate(
  edad = 2024 - year(cotizantes$fecha_nac),
  meses = 12 - month(cotizantes$fecha_nac)
)
cotizaciones <- BD_Cotizantes %>% select(-1,-2,-3)
pensionados <- cbind(pensionados, BD_Pensionados) 
pensionados <- pensionados %>% select(-c(4,7,8))
pensionados <- pensionados %>% mutate(
  edad = 2024 - year(pensionados$fecha_nac)
)

niveles <- 110.39017/IPC$Nivel[229:588]
```

## Funciones alternas
```{r, message=FALSE}
source("cod/curva_dens.R")
source("cod/curva_salarial.R")
source("cod/vp_pen_futuras.R")
```

### Curva salarial
```{r}
curv_sal <- curva_salarial$s_x
plot(cumprod(curv_sal))
```

### Propiedades de cotizaciones
```{r}
cotizantes <- cbind(cotizantes, cot_prop())
```

### Curva de densidades de cotizacion
```{r}
curv_dens <- curva_densidad$media
plot(curv_dens)
```

### Obtención de matrices de probabilidad de muerte
```{r}
find_qx <- function(x, sexo, año){
  return(SUPEN[which(SUPEN$sex == sexo & SUPEN$year == año & SUPEN$edad == x),6])
}
año <- 2025
system.time(
all_qx <- list(
  sapply(0:95, function(y) sapply(0:115, function(x) find_qx(x, 1, año+y))),
  sapply(0:95, function(y) sapply(0:115, function(x) find_qx(x, 2, año+y))))
)
```

```{r}
sal_pen <- function(){
  pensiones <- list()
  for(id in 1:5196){
    x <- cotizantes$edad[id]
    cuota <- cotizantes$cuotas[id]
    sal_prom <- cotizantes$sal_prom[id]
    cuotas_past <- cotizaciones[id,]
    n_cot <- c(0,cumsum(curv_dens[(x-19):96]))+cuota
    salarios <- cumprod(curv_sal[(x-19):96])*sal_prom
    enteros <- round(n_cot - n_cot[1])
    cantidades <- enteros[-1] - enteros[-length(enteros)]
    sal_pen <- rep(0, 115-x)
    sal_pen[1] <- salarios[1]
    cuotas <- unlist(cuotas_past*niveles)
    cuotas <- cuotas[cuotas>10000]
    if(sal_prom == 0){ # supone que ya no va a trabajar?
      pensiones[[id]] <- rep(mean(head(sort(
        cuotas[sum(1 - cuotas < 5e6)/enteros[i+1] > 0.5 | cuotas < 5e6],
        decreasing = T), 300)), 114-x)
      next
    }
    for(i in 1:(114-x)){
      cuotas <- c(cuotas, rep(salarios[i+1], cantidades[i]))
      calc_pen <- cuotas[sum(1 - cuotas < 5e6)/enteros[i+1] > 0.5 | cuotas < 5e6]
      sal_pen[i+1] <- mean(head(sort(calc_pen, decreasing = T), 300))
    }
    porc <- c(0.525,0.51, 0.494, 0.478, 0.462, 0.446, 0.43)
    montos <- c(2,3,4,5,6,8) * 367108.55
    indices <- findInterval(sal_pen, montos) + 1
    sal_pen <- sal_pen * porc[indices]
    pensiones[[id]] <- sal_pen
  }

  return(pensiones)
}
```


### Precálculo de las pensiones
```{r}
system.time(pensiones <- sal_pen())
```

### Obtención del interés
```{r}
hoja <- BD_Financiero[[3]]
int_mes <- sapply(1:120, function(x)  (hoja[x+1, 2] - hoja[x,2] - hoja[x,4] + hoja[x,5])/(hoja[x,2] + (hoja[x,4] - hoja[x,5])/2)+1)
int_mes <- unlist(int_mes)
int <- sapply(1:109, function(x) prod(int_mes[x:(11+x)])-1)
plot(int)
lines((0:109)*-0.0003859 + 0.177)
```

```{r}
inf_max <- IPC$Nivel[564]/IPC$Nivel[552] - 1
(int_real <- mean(int) - inf_max)
```

```{r}
rm(BD_Cotizantes,
   BD_Pensionados,
   BD_Financiero,
   poblacion, 
   IPC, 
   cuentas, 
   cot_prop,
   curva_sal,
   curva_dens, 
   SUPEN,
   unicos, 
   find_qx, 
   hoja,
   int, 
   inf_max, 
   int_mes, 
   sal_pen
   )
```

# Balance Actuarial
## Cálculo del VP de beneficios de pensiones futuras
```{r}
t <- proc.time()
datos <- vp_pen_futuras(int_real, 0.02)/1e9
proc.time() - t
```

```{r}
colSums(datos)[1:4]
```


# desde 0 >:(

## Objetivo
calcular las pensiones por anualidades de mortalidad, en la función traerlas a vp

## Pensión por invalidez a edad $x \in [20, 115]$
```{r}
pen_inv <- function(){
  w <- 115
  pen_inv <- list()
  for(sex in 1:2){
    inv <- list()
    for(x in 20:w){
      res <- (w-x+1)
      px <- 1-sapply(1:res, function(y) all_qx[[sex]][x+y, y]) # por si acaso, 
      # la edad es una más en la tabla all_qx
      qi <- all_qix[[1]][1:res]
      pi <- 1-qi
      tpx <- cumprod(px)
      tpix <- c(1,cumprod(pi)[-res]) # prioridad de invalidez sobre retiro
      vida <- sapply(1:res, function(x) c(tpix[0:(x-1)], rep(qi[x]*tpix[x], res-x+1)))
      vida <- t(vida*tpx)
      diag(vida) <- diag(vida)
      inv[[x-19]] <- vida
    }
    pen_inv[[sex]] <- inv
  }
  return(pen_inv)
}
```

```{r}
inv <- pen_inv()
```

## Pensión por vejez a edad $x \in [20, 115]$
Como depende del individuo, se calculan todos los posibles casos de pensión por edad por sexo

```{r}
sob_vej <- function(){
  w <- 115
  pen <- list()
  for(sex in 1:2){
    ret <- list()
    for(x in 20:w){
      res <- (w-x+1)
      px <- 1-sapply(1:res, function(y) all_qx[[sex]][x+y, y])
      pi <- 1-all_qix[[1]][1:res]
      tpx <- cumprod(px)
      tpix <- cumprod(pi) # prioridad invalidez sobre retiro
      vida <- t(sapply(1:res, function(x) c(tpix[1:x], rep(tpix[x], res-x))*tpx))
      ret[[x-19]] <- vida
    }
    pen[[sex]] <- ret
  }
  return(pen)
}
```

```{r}
pen <- sob_vej()
```

## Pensión por viudez a edad $x \in [20, 115]$
```{r}
pen_viu <- function(){
  w <- 115
  pen_viu <- list()
  for(sex in 1:2){
    viu <- list()
    for(x in 20:w){
      res <- (w-x+1)
      if(x < 50){
        porc_viu <- c(rep(0.5, 50-x), rep(0.6, 10), rep(0.7, w+1-60))
      } else if(x < 60){
        porc_viu <- c(rep(0.6, 60-x), rep(0.7, w+1-60))
      } else {
        porc_viu <- c(rep(0.7, res))
      }
      vpx <- 1 - sapply(1:res, function(y) all_qx[[3-sex]][x+y, y])
      vtpx <- cumprod(vpx)
      vida <- t(sapply(1:res, function(x) c(rep(0, x-1), vtpx[x:res])*porc_viu))
      viu[[x-19]] <- vida
    }
    pen_viu[[sex]] <- viu
  }
  return(pen_viu)
}
```

```{r}
viu <- pen_viu()
```

## Pensión por orfandad a edad $x \in [20, 115]$
```{r}
pen_orf <- function(){
  w <- 115
  pen_orf <- list()
  for(sex in 1:2){
    orf <- list()
    for(x in 20:49){
      res <- (w-x+1)
      if(x < 25){
        porc_orf <- c(rep(0, 25-x), rep(0.3, 25), rep(0, res+x-50))
      } else if(x<50){
        porc_orf <- c(rep(0.3, 50-x), rep(0, res-50+x))
      } else {
        orf[[x-19]]  <- rep(0, res)
        next
      }

      opx <- 1 - (sapply(1:res, function(y) all_qx[[1]][x+y, y]) + 
                    sapply(1:res, function(y) all_qx[[2]][x+y, y]))/2
      otpx <- cumprod(opx)
      vida <- t(sapply(1:res, function(x) c(rep(0, x-1), otpx[x:res])*porc_orf))
      orf[[x-19]] <- vida
    }
    pen_orf[[sex]] <- orf
  }
  return(pen_orf)
}
```

```{r}
orf <- pen_orf()
```

## Precálculo de los qx

```{r}
pc_qx <- function(){
    w <- 115
  difsex <- list()
  for(sex in 1:2){
    tqx <- list()
    for(x in 20:w){
      res <- (w-x)
      qx <- sapply(1:res, function(y) all_qx[[sex]][x+y, y])
      tqx[[x-19]] <- qx
    }
    difsex[[sex]] <- tqx
  }
  return(difsex)
}
```

```{r}
qx <- pc_qx()
```


## Cálculo con pensiones precalculadas
### Función para leer sumas de columnas de matrices triangulares
```{r}
readt <- function(mat){
  return(sapply(1:ncol(mat), function(x) sum(mat[1:x,x])))
}
```

```{r}
vp_pen_fut <- function(int, inf){
  int_ef <- ((1+int)/(1+inf))
  anual <- (1 - int_ef^-1)/(int_ef^(1/12) -1)
  limit2 <- 2e6*int_ef^-(0:95)
  limit3.5 <- 3.5e6*int_ef^-(0:95)
  cot_min <- sapply(0:95, function(y) cotizacion_minima(20+y, 2)[1])
  edad_min <- sapply(0:95, function(y) cotizacion_minima(20+y, 2)[2])
  res <- data.frame(Inv = rep(0, 96), Pen = 0, Suc = 0, SEM = 0, Cot = 0)
  # Doble iteración para recorrer toda la data, individuos y años
  for(id in 1:5196){
    # Preliminares del individuo
    x <- cotizantes$edad[id]
    sexo <- cotizantes$sexo[id]
    cuota_ini <- cotizantes$cuotas[id]
    int_years <- 0:(115-x)
    vp_pen <- c(pensiones[[id]],0)*int_ef^(-int_years)
    ind_cot <- vp_pen > limit2[1:length(sal_pen)]
    
    temp <- vp_pen[ind_cot]
    vp_pen[ind_cot] <- temp*0.95
    cot_pen <- rep(0, length(vp_pen))
    cot_pen[ind_cot] <- temp*0.05
    n_cot <- cuota_ini + cumsum(curv_dens[(x-19)+int_years])

    if(sexo == 1){
      cond_pen <- n_cot >= 300 & x+int_years >= 65
    } else {
      cond_pen <- n_cot >= cot_min[int_years+1] & x+int_years >= edad_min[int_years+1]
    }
    ini_pen <- first(which(cond_pen))
    cot_ad <- (n_cot[ini_pen]-300)/1200 + 1
    porc_pen <- sapply(int_years+1, function(y) min(1.25,max(0,n_cot[y]-n_cot[ini_pen])*2/1500+cot_ad))
    
    # Inicialización del dataframe del individuo
    per <- data.frame(inv = rep(0,115-x+1), pen = 0, viu = 0, orf = 0, cotinv = 0, cotpen = 0, cotviu = 0, cotorf = 0)
    limit <- limit3.5[int_years+1]

    cot_pen[vp_pen > limit] <- cot_pen[vp_pen > limit] +
      vp_pen[vp_pen > limit] - limit[vp_pen > limit]
    vp_pen[vp_pen > limit] <- limit[vp_pen > limit]
    vp_pen <- vp_pen*(anual + int_ef^(-11/12))
    cot_pen <- cot_pen*(anual + int_ef^(-11/12))
    
    data_inv <- inv[[sexo]][[x-19]]
    cond_inv <- n_cot >= 180 | cot_min_inv(x+int_years)
    cond_invp <- (n_cot>=60)*n_cot/180
    data_pen <- pen[[sexo]][[x-19]]
    cond_penp <- (n_cot >= 180 & x+int_years >= 65)*n_cot/300
    
    # Condiciones de invalidez
    temp <- data_inv*(cond_inv + (!cond_inv & cond_invp))
    per$inv <- readt(temp*vp_pen)
    per$cotinv <- readt(temp*cot_pen)
    
    # Condiciones de vejez
    qr <- c(rep(0, ini_pen-1), (0.09)^(0:(115-x+1-ini_pen))*0.9)
    temp <- data_pen*(cond_pen*porc_pen + (!cond_pen * cond_penp))*qr
    per$pen <- readt(temp*vp_pen)
    per$cotpen <- readt(temp*cot_pen)

    # Condiciones de sucesión 
    mux <- qx[[sexo]][[x-20]]
    cond_suc <- (n_cot >= 180)*c(1,diag(data_pen)[-ncol(data_pen)])*mux*((n_cot >= 300)*porc_pen+(!n_cot >= 300)*n_cot/300)
    suc_pen <- (per$pen+per$inv)*mux +  cond_suc*vp_pen
    suc_cot <- (per$cotpen+per$cotinv)*mux +  cond_suc*cot_pen
    # no importa invalidez y muerte al mismo tiempo, entonces por eso el 1 al inicio. 
    # Los demás si para no contabilizar doble pensión
    per$viu <- readt(viu[[sexo]][[x-19]]*suc_pen)
    per$cotviu <- readt(viu[[sexo]][[x-19]]*suc_cot)
    if(x < 50){
      per$orf <- readt(orf[[sexo]][[x-19]]*suc_pen)
      per$cotorf <- readt(orf[[sexo]][[x-19]]*suc_cot)
    }
    # browser()
    
    res$Inv <- res$Inv + c(per$inv, rep(0, 95-(115-x)))
    res$Pen <- res$Pen + c(per$pen, rep(0, 95-(115-x)))
    res$Suc <- res$Suc + c(per$viu + per$orf, rep(0, 95-(115-x)))
    res$Cot <- res$Cot + c(per$cotinv+ per$cotpen + per$cotviu + per$cotorf, rep(0, 95-(115-x)))
  }
  res$SEM <- 0.085*anual*(res$Inv+res$Pen+res$Suc)/(anual + int_ef^(-11/12))
  
  return(t(res*int_ef^(-(1:96))))
}
```

```{r}
t <- proc.time()
datos <- vp_pen_fut(int_real, 0.02)/1e9
proc.time() - t
```

```{r}
rowSums(datos)[1:4]
```

# Modelo estocástico
Resultados similares pero diferentes -> Modelo estocástico

```{r}
curva_densidad$media <- curva_densidad$media/12
curva_densidad$std <- curva_densidad$std/12
```

```{r}
cotizaciones <- cotizaciones*niveles
cuotas <- list()
for(i in 1:5196){
  cuotas[[i]] <- sapply(26:30, function(x) sum(cotizaciones[i,1:12+(12*(x-1))] > 1e4))
}
```

```{r}
oqx <- sapply(0:24, function(x)
  sapply(x:24, function(y)
    (all_qx[[1]][y+1,y-x+1] + all_qx[[2]][y+1,y-x+1])/2
    )
  )
```


```{r}
proy_est <- function(int, inf){
  v <- (1+inf)/(1+int)
  porc <- c(0.525,0.51, 0.494, 0.478, 0.462, 0.446, 0.43)
  montos <- c(2,3,4,5,6,8) * 367108.55
  res <- data.frame(Inv = rep(0, 96), Pen = 0, Suc = 0, CotAct = 0, CotPen = 0, SEM = 0)
  anual <- (1-v)/(v^(-1/12)-1)
  min_inv <- sapply(20:115, function(x) cot_min_inv(x))
  for(id in 1:5196){
    cuotash <- cuotas[[id]]
    cuota <- cotizantes$cuotas[id]
    sexo <- cotizantes$sexo[id]
    x <- cotizantes$edad[id]
    salario <- cotizantes$sal_prom[id] 
    estado <- 0
    px <- 1-qx[[sexo]][[x - 19]]
    vpx <- 1-qx[[3-sexo]][[x - 19]]
    pix <- 1-all_qix[[sexo]][(x-19):96]
    cuotash <- c(cuotash, rep(0, 95))
    salariosh <- unlist(cotizaciones[id,])
    first_pen <- T
    roll_pen <- F
    cond_hij <- F
    cond_viu <- F
    porc_pen <- 1
    cot_pen <- 0
    for(j in 1:(115-x)){
      if(estado == 0){ # Trabaja
        if(runif(1) > px[j]){ # Muerte directa
          if(cuota >= 180 | sum(cuotash[(j+2):(j+4)])>=12){ # Solo si aplica
            estado <- 3
            cond_viu <- T
            if(x+j-25 >=0 & x+j-25 <25){
              cond_hij <- T
              c <- j-1
              opx <- 1 - oqx[[x+j-24]]
            }
          } else { # no hay sobrevivientes ni pensión alguna
            next
          }
          
        } else if(runif(1)>pix[j]){ # Invalidez
          if(cuotash[j+1] >= 180){
            estado <- 2
          } else if(x + j-1 < 48 & sum(cuotash[(j+2):(j+4)])>=12 & cuota > min_inv[x+j-19]){
            estado <- 2
          } else if(x + j-1 >= 48 & sum(cuotash[j:(j+4)])>=24 & cuota > min_inv[x+j-19]){
            estado <- 2
          } else if(cuota >= 60 & (sum(cuotash[(j+2):(j+4)])>=12|sum(cuotash[j:(j+4)])>=24)){
            estado <- 2
            porc_pen <- cuota/180
          } else { # No hay pensión ni sucesoria, gracias por aportar
            next
          }
        } else { # sobrevive, e invalidez > retiro
          prob_cot <- min(max(0, rnorm(1, 
                  curva_densidad$media[x+j-20], curva_densidad$std[x+j-20])),1)
          cuotash[j+5] <- rbinom(1, 12, prob_cot) 
          cuota <- cuota + cuotash[j+5]
          # if(salario == 0 & runif(1) < prob_cot){ # probabilidad de volver a trabajar
          #   salario <- cotizantes$sal_prom[id]
          # }
          salario <- salario*max(0,rnorm(1, curva_salarial$s_x[x+j-20],
                                         curva_salarial$std[x+j-20]))
          salariosh <- c(salariosh, rep(salario, cuotash[j+5]))
          res$CotAct[j] <- res$CotAct[j] + 0.15*cuotash[j+5]*salario # cotizaciones
          if(x+j-1 >= 65 & cuota >= 300){
            roll_pen <- T
          } else if (sexo == 2 & x+j-1 == 64 & cuota >= 357){
            roll_pen <- T
          } else if (sexo == 2 & x+j-1 == 63 & cuota >= 405){
            roll_pen <- T
          } else if (x+j-1 >= 65 & cuota >= 180 & runif(1) >= 0.9){
            estado <- 1
            porc_pen <- cuota/300
          }
          if(roll_pen){ # para ver si se retira
            roll_pen <- F
            if(first_pen){
              first_pen <- F
              ini_pen <- cuota
            }
            if(runif(1) >= 0.9){
              estado <- 1
              porc_pen <- min(1.25, 1 + (cuota-ini_pen)*2/1500 + (ini_pen-300)/1200)
            }
          }
        }
        if(estado == 1 | estado == 2 | estado == 3){
          # Se acaba justo de cambiar y hay que calcular la pensión
          cot5m <- T
          if(sum(salariosh > 5e6*v^(1/12*-359:(length(salariosh)-360)))<0.5){ # histórico 5 millones
            cot5m <- !salariosh > 5e6*v^(1/12*-359:(length(salariosh)-360))
          }
          salariosh <- salariosh[salariosh > 10000 & cot5m]
          sal_pen <- mean(head(sort(salariosh),300)) # ya están en vp
          sal_pen <-  sal_pen*porc[findInterval(sal_pen, montos) + 1]*porc_pen 
          if(sal_pen > 2e6*(1+inf)^-j){
            cot_pen <- sal_pen*0.05
            sal_pen <- sal_pen*0.95
          } 
          if(sal_pen > 3.5e6*(1+inf)^-j){
            cot_pen <- cot_pen + sal_pen - 3.5e6*(1+inf)^-j
            sal_pen <- 3.5e6*(1+inf)^-j
          }
          sal_pen <- (anual+v^(11/12))*sal_pen # anualidad más aguinaldo
          if(estado == 1){
            res$Pen[j] <- res$Pen[j] + sal_pen
            res$CotPen[j] <- res$CotPen[j] + cot_pen
          } else if(estado == 2) {
            res$Inv[j] <- res$Inv[j] + sal_pen 
            res$CotPen[j] <- res$CotPen[j] + cot_pen
          }
        }
      } else if(estado == 1 | estado == 2){ # Pensionado
        if(runif(1) > px[j]){ # Muerte directa. Como ya está pensionado si recibe
          estado <- 3
          cond_viu <- T
          if(x+j-25 >=0 & x+j-25 <25){
            cond_hij <- T
            c <- j-1
            opx <- 1 - oqx[[x+j-24]]
          }
        }
        # sigue un pago más
        if(estado == 1){
          res$Pen[j] <- res$Pen[j] + sal_pen
          res$CotPen[j] <- res$CotPen[j] + cot_pen
        } else if(estado == 2) {
          res$Inv[j] <- res$Inv[j] + sal_pen 
          res$CotPen[j] <- res$CotPen[j] + cot_pen
        }
      }
      if(estado == 3){ # Muerto, considerando reciente
        if(cond_hij){ # si hay un hijo
          if(x+j-25 >= 24){ # si ya creció y pasó los 25 años
            cond_hij <- F # ya no más pensión
          }
          if(runif(1) > opx[j-c]){ # se muere el hijo
            cond_hij <- F
          } else {
            res$Suc[j] <- res$Suc[j] + sal_pen*0.3
            res$CotPen[j] <- res$CotPen[j] + cot_pen*0.3
          }
        }
        if(cond_viu){
          if(runif(1) < vpx[j]){
            if(x+j-1 < 50){
              res$Suc[j] <- res$Suc[j] + sal_pen*0.5
              res$CotPen[j] <- res$CotPen[j] + cot_pen*0.5
            } else if(x+j-1 < 60){
              res$Suc[j] <- res$Suc[j] + sal_pen*0.6
              res$CotPen[j] <- res$CotPen[j] + cot_pen*0.6
            } else {
              res$Suc[j] <- res$Suc[j] + sal_pen*0.7
              res$CotPen[j] <- res$CotPen[j] + cot_pen*0.7
            }
          } else {
            cond_viu <- F # se muere el cónyuge
          }
        }
      }
    } 
  }
  res[,1:5] <- res[,1:5]*v^(-1/2)*v^(1:95)
  res$SEM <- (res$Inv + res$Pen + res$Suc)*anual/(anual+v^(11/12))*0.085
  return(res)
}
```

```{r}
t <- proc.time()
datos <- proy_est(int_real, 0.02)
proc.time()-t
```

```{r}
colSums(datos)/1e9
```



























