---
title: "Proyecto - Pensiones I"
author: 
  - Luis Fernando Amey Apuy - C20470
  - Javier Hernández Navarro - C13674
  - Anthony Mauricio Jiménez Navarro - C24067
  - Gustavo Alberto Amador Fonseca - C20459
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    highlight: tango
---
# Librerías e importaciones
```{r, warning=FALSE, message=FALSE}
source("cod/setup.R")
source("cod/load_database.R")
```

# Tomar los trabajadores activos
Una cuota de 10000 no cuenta como cotización
```{r}
ultimo_año <- data.frame(activo = rowSums(BD_Cotizantes %>%
                                select(tail(names(.), 12)) > 10000)>0)
```

# Gráficos de CDR
## Estructura de la población
```{r}
cotizantes <- BD_Cotizantes %>% 
  select(2,3) %>% 
  mutate(estado = ultimo_año$activo)
pensionados <- BD_Pensionados %>% 
  select(4,5) %>% 
  mutate(estado = 2)
names(pensionados) <- names(cotizantes)
poblacion <- rbind(cotizantes, pensionados) %>% 
  mutate(edad = 2024 - year(Fec.Nac)) %>% 
  select(-1)
names(poblacion) <- tolower(names(poblacion))
poblacion[poblacion$sexo == "1",]$sexo <- "M"
poblacion[poblacion$sexo == "2",]$sexo <- "F"
cotizantes <- poblacion[1:5196,]
pensionados <- poblacion[5197:5561,]
```

```{r}
# Crear grupos de edad
df <- poblacion %>%
  mutate(grupo_edad = cut(
    edad,
    breaks = seq(0, 100, by = 5),
    right = FALSE,
    labels = paste(seq(0, 95, by = 5), seq(4, 99, by = 5), sep = "-")
  ))

# Agrupar por grupo de edad y sexo
df_piramide <- df %>%
  group_by(grupo_edad, sexo) %>%
  summarise(poblacion = n(), .groups = "drop") %>%
  mutate(poblacion = ifelse(sexo == "M", -poblacion, poblacion))

fig <- ggplot(df_piramide, aes(x = grupo_edad, y = poblacion, fill = sexo)) +
  geom_bar(stat = "identity", width = 0.9) +
  coord_flip() +
  scale_y_continuous(
    labels = abs,
    limits = c(-1, 1) * max(abs(df_piramide$poblacion))
  ) +
  labs(
    x = "Grupo de Edad",
    y = "Población",
    fill = "Sexo"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
  )

ggsave("res/piramide.pdf", fig)


```

```{r}
df <- poblacion %>%
  mutate(
    sexo = recode(sexo, "M" = "Hombre", "F" = "Mujer"),
    estado = recode_factor(
      as.character(estado),
      "1" = "Activo",
      "0" = "No activo",
      "2" = "Pensionado"
    )
  )

# Agrupación por sexo
sexo_df <- df %>%
  count(categoria = sexo) %>%
  mutate(grupo = "Sexo")

# Agrupación por estado
estado_df <- df %>%
  count(categoria = estado) %>%
  mutate(grupo = "Estado")

resumen <- bind_rows(sexo_df, estado_df)

colores <- c(
  "Hombre" = "#377EB8",
  "Mujer" = "#984EA3",
  "Activo" = "#4DAF4A",
  "No activo" = "#FF7F00",
  "Pensionado" = "#999999"
)


fig <- ggplot(resumen, aes(x = grupo, y = n, fill = categoria)) +
  geom_bar(stat = "identity", position = "stack", width = 0.6) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "black", size = 4) +
  scale_fill_manual(values = colores) +
  labs(
    x = NULL,
    y = "Cantidad de Personas",
    fill = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(size = 12),
    legend.position = "right"
  )

ggsave("res/resumen_pob.pdf", fig)

```

## Población activa
```{r}
cotizantes_activos <- cotizantes[cotizantes$estado == 1, ]

bar_totals <- cotizantes_activos %>%
  count(edad) %>%
  mutate(
    mitad = n / 2,
    edad = factor(edad)  
  )


fig <- ggplot(cotizantes_activos, aes(x = factor(edad), fill = sexo)) +
  geom_bar(position = "stack") +
  # Línea horizontal en la mitad de cada barra
  geom_segment(
    data = bar_totals,
    aes(x = edad, xend = edad, y = mitad - 0.5, yend = mitad + 0.5),
    inherit.aes = FALSE,
    color = "black",
    linewidth = 3
  ) +
  scale_x_discrete(
  breaks = as.character(seq(min(cotizantes_activos$edad), max(cotizantes_activos$edad), by = 5))
  ) +
  labs(
    x = "Edad",
    y = "Cantidad de cotizantes activos"
  ) +
  theme_minimal() 

ggsave("res/dist_activos.pdf", fig)
```


```{r}
cotizantes <- cotizantes %>% 
  mutate(antiguedad = apply(BD_Cotizantes[, 4:ncol(BD_Cotizantes)], 1, function(x) which(x != 0)[1]))
cotizantes$antiguedad <- 2024 - year(as_datetime(names(BD_Cotizantes)[cotizantes$antiguedad+3]))
```

```{r}
fig <- ggplot(cotizantes, aes(x = antiguedad, fill = sexo)) + 
  geom_bar(position = "stack") +
  labs(
    x = "Años de antiguedad en el régimen",
    y = "Cantidad de personas"
  ) +
  theme_minimal()

ggsave("res/activos_ant.pdf", fig)
```


## Población pensionada
```{r}
bar_totals <- pensionados %>%
  count(edad) %>%
  mutate(
    mitad = n / 2,
    edad = factor(edad) 
  )

fig <- ggplot(pensionados, aes(x = factor(edad), fill = sexo)) +
  geom_bar(position = "stack") +
  scale_x_discrete(
  breaks = as.character(seq(min(pensionados$edad), max(pensionados$edad), by = 5))
  ) +
  labs(
    x = "Edad",
    y = "Cantidad de cotizantes activos"
  ) +
  theme_minimal() 
ggsave("res/dist_pensionados.pdf", fig)
```

```{r}
pensionados <- pensionados %>% 
  mutate(antiguedad = 2024 - year(BD_Pensionados$`Rige de la Pensión`))
fig <- ggplot(pensionados, aes(x = antiguedad, fill = sexo)) + 
  geom_bar(position = "stack") +
  labs(
    x = "Años pensionado",
    y = "Cantidad de pensionados"
  ) +
  theme_minimal() 
ggsave("res/pensionados_ant.pdf", fig)
```

## Comportamiento de altas y bajas de afiliados
```{r}
n_meses <- ncol(BD_Cotizantes) - 3

# cuántas ventanas de 12 meses podemos formar
n_periodos <- n_meses - 12 + 1
if(n_periodos < 1) stop("¡No hay suficientes meses para formar un año completo!")

# Preparamos un objeto para guardar los indicadores
activo <- matrix(0L, 
                 nrow = nrow(BD_Cotizantes), 
                 ncol = n_periodos)

# Recorremos cada “ventana” de 12 meses
for(k in seq_len(n_periodos)){
  cols_k <- (3 + k):(3 + k + 11)    # e.g. para k=1, cols 4:15; para k=2, 5:16; etc.
  submat  <- BD_Cotizantes[, cols_k]
  
  # fila i = 1 si en esos 12 meses hubo al menos 1 >0
  activo[, k] <- as.double(rowSums(submat > 0) > 0)
}

# Ponemos nombres a cada periodo (opcional)
colnames(activo) <- colnames(BD_Cotizantes)[15:363]

# Finalmente, volcamos en comportamientos
# (aquí asumo que quieres mantener las 3 primeras columnas y luego estos indicadores)
comportamientos <- cbind(
  BD_Cotizantes[, 1:3],
  as.data.frame(activo)
)
```

```{r}
afiliados <- data.frame(fecha = colnames(BD_Cotizantes)[15:363], activos = colSums(activo))
fig <- ggplot(afiliados, aes(x = fecha, y = activos)) + 
  scale_x_discrete(breaks = afiliados$fecha[seq(1, nrow(afiliados), by = 60)]) +
  geom_point(color = 'purple') +
    labs(
    x = "Fecha",
    y = "Cantidad de afiliados"
  ) +
  theme_minimal() 
ggsave("res/comportamiento.pdf", fig)
```

```{r}
diffs <- activo[, -1, drop = FALSE] - activo[, -ncol(activo), drop = FALSE]

Altas     <- colSums(diffs ==  1)  # pasó de 0 a 1
Bajas     <- colSums(diffs == -1)  # pasó de 1 a 0

resultado <- data.frame(
  fecha     = colnames(BD_Cotizantes)[16:363],
  Altas     = Altas,
  Bajas     = Bajas,
  Afiliados = colSums(activo)[2:349],
  row.names = NULL
)

```

```{r}
rm(activo,
   afiliados, 
   bar_totals,
   comportamientos,
   cotizantes,
   cotizantes_activos,
   df,
   df_piramide,
   diffs,
   estado_df, 
   fig,
   pensionados,
   poblacion,
   resultado,
   resumen,
   sexo_df,
   submat,
   Altas, 
   Bajas, 
   colores,
   cols_k,
   k,
   n_meses,
   n_periodos)
```

# Informe Situación Actual
## Población general
Se van a tomar como variables:
- La tasa de interés
- La tasa de inflación
Para poder hacer un análisis de sensibilidad luego
```{r}
cotizantes <- BD_Cotizantes %>% select(Fec.Nac, Sexo)
names(cotizantes) <- c('fecha_nac', 'sexo')
pensionados <- BD_Pensionados %>% select(FEC_NAC, SEXO)
names(pensionados) <- c('fecha_nac', 'sexo')
pensionados <- pensionados  %>%
  mutate(sexo = ifelse(sexo == "M", 1, 2))
poblacion <- rbind(cotizantes, pensionados) %>% mutate(
  edad = 2024 - year(poblacion$fecha_nac)
)
cuentas <- poblacion %>% count(sexo,edad)
unicos <- cuentas %>% select(sexo, edad)
```

```{r}
pensionados <- pensionados %>% mutate(
  edad = 2024 - year(pensionados$fecha_nac)
)
pen <- cbind(pensionados, BD_Pensionados) 
pen <- pen %>% select(-c(4,7,8))
```

## Obtener probabilidades de muerte

```{r}
#' Calcula las probabilidades de vida para todos los años de cada persona
#' @param df_obs caracteristicas de cada persona
#' @param df_prob tabla dinámica de las proabilidades de muerte
#' @return all_qx (una lista que adentro contiene: 1. Una lista con las probabilidades de sobrevivencia para cada persona. 2. El sexo. 3. La edad)
get_px <- function(df_obs, df_prob){
  c <- 0
  all_px = list()
  
  #Se filtra la base con las probabilidades según el sexo
  hombres <- df_prob[df_prob$sex == 1,]
  mujeres <- df_prob[df_prob$sex == 2,]
  
  #se itera sobre todas las observaciones del df_obs
  for (i in 1:nrow(df_obs)){ 
    x <- df_obs$edad[i]
    y <- 2025 
    local_px <- list()
    n <- 1 
    c <- c+1
    
    # Primer filtro: sexo
    if(df_obs$sexo[i] == 1){
      df <- hombres
    } else {
      df <- mujeres
    }
    
    # Para encontrar todas las probabilidades futuras de esa persona
    while (any(df$edad == x & df$year == y)) {
      # Filtrar datos por edad y año actual para encontrar el qx
      qx <- df[df$edad == x & df$year == y , 6]
      
      # Se calcula la probabilidad de sobrevivencia
      local_px[n] <- 1 - qx

      n <- n + 1
      x <- x + 1
      y <- y + 1
    }

    # Se guardan las probabilidades
    all_px[[c]] <- local_px 
  }
  
  #Se devuelve la lista con una lista para cada observación
  return(all_px)
}
```

```{r}
px <- get_px(unicos, SUPEN)
unicos$id <- 1:141
```

## Propiedades de cotización

```{r}
prop_cot <- function(){
  cot <- BD_Cotizantes %>% select(-1,-2,-3)
  data <- cot != 0
  does_cot <- sapply(1:nrow(data), function(x) which(data[x,]))
  inicios <- sapply(1:nrow(data), function(x) first(does_cot[[x]]))
  
  # Densidades de cotización
  dens_cot <- sapply(1:nrow(data), function(x) mean(data[x,inicios[x]:ncol(data)]))
  
  # Promedio de los 300 mejores salarios
  s65 <- sapply(1:nrow(data), function(x) 
    mean(head(sort(unlist(cot[x,does_cot[[x]]]), decreasing = T), 300)))
  
  
  
  return(list(dens_cot, s65))
}
```

## Reservas
```{r}
reserva <- function(int, inf){
  int_ef <- ((1+int)/(1+inf))^(-1/12) 
  
  
  
  # 1! interes real? Qué interés? 5%? R/ fundamentar
  # 2! mortalidades/invalidez mensuales? o anual, con todo del año traído a VP? R/ densidad cotización
  # 3! cotizaciones futuras? R/ salario proyectado
  # 4! 
}
```
























