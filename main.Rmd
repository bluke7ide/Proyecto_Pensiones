---
title: "Proyecto - Pensiones I"
author: 
  - Luis Fernando Amey Apuy - C20470
  - Javier Hernández Navarro - C13674
  - Anthony Mauricio Jiménez Navarro - C24067
  - Gustavo Alberto Amador Fonseca - C20459
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    highlight: tango
---
# Librerías e importaciones
```{r, warning=FALSE, message=FALSE}
source("cod/setup.R")
source("cod/load_database.R")
```

# Gráficos de CDR
```{r}
source("cod/graficos.R")
```

```{r}
rm(activo,
   afiliados, 
   bar_totals,
   comportamientos,
   cotizantes,
   cotizantes_activos,
   df,
   df_piramide,
   diffs,
   estado_df, 
   fig,
   pensionados,
   poblacion,
   resultado,
   resumen,
   sexo_df,
   submat,
   Altas, 
   Bajas, 
   colores,
   cols_k,
   k,
   n_meses,
   n_periodos, 
   invalidez,
   ultimo_año)
```

# Preparación Balance
## Población general
```{r}
cotizantes <- BD_Cotizantes %>% select(Fec.Nac, Sexo)
names(cotizantes) <- c('fecha_nac', 'sexo')
pensionados <- BD_Pensionados %>% select(FEC_NAC, SEXO)
names(pensionados) <- c('fecha_nac', 'sexo')
pensionados <- pensionados  %>%
  mutate(sexo = ifelse(sexo == "M", 1, 2))
poblacion <- rbind(cotizantes, pensionados) 
poblacion <- poblacion %>% mutate(
  edad = 2024 - year(poblacion$fecha_nac)
)
cuentas <- poblacion %>% count(sexo,edad)
unicos <- cuentas %>% select(sexo, edad)
```

```{r}
pensionados <- pensionados %>% mutate(
  edad = 2024 - year(pensionados$fecha_nac),
  meses = 12 - month(pensionados$fecha_nac)
)
cotizantes <- cotizantes %>% mutate(
  edad = 2024 - year(cotizantes$fecha_nac),
  meses = 12 - month(cotizantes$fecha_nac)
)
cotizaciones <- BD_Cotizantes %>% select(-1,-2,-3)
pensionados <- cbind(pensionados, BD_Pensionados) 
pensionados <- pensionados %>% select(-c(4,8))
pensionados <- pensionados %>% mutate(
  edad = 2024 - year(pensionados$fecha_nac)
)

niveles <- 110.39017/IPC$Nivel[229:588]
```

## Funciones alternas
```{r, message=FALSE}
source("cod/curva_dens.R")
source("cod/curva_salarial.R")
source("cod/vp_pen_futuras.R")
source("cod/funciones_alternas.R")
```

### Curva salarial
```{r}
curv_sal <- curva_salarial$s_x
plot(cumprod(curv_sal))
```

### Propiedades de cotizaciones
```{r}
cotizantes <- cbind(cotizantes, cot_prop())
```

### Curva de densidades de cotizacion
```{r}
curv_dens <- curva_densidad$media
plot(curv_dens)
```

### Obtención de matrices de probabilidad de muerte
```{r}
find_qx <- function(x, sexo, año){
  return(SUPEN[which(SUPEN$sex == sexo & SUPEN$year == año & SUPEN$edad == x),6])
}
año <- 2025
system.time(
all_qx <- list(
  sapply(0:95, function(y) sapply(0:115, function(x) find_qx(x, 1, año+y))),
  sapply(0:95, function(y) sapply(0:115, function(x) find_qx(x, 2, año+y))))
)
```

```{r}
sal_pen <- function(){
  pensiones <- list()
  for(id in 1:5196){
    x <- cotizantes$edad[id]
    cuota <- cotizantes$cuotas[id]
    sal_prom <- cotizantes$sal_prom[id]
    cuotas_past <- cotizaciones[id,]
    n_cot <- c(0,cumsum(curv_dens[(x-19):96]))+cuota
    salarios <- cumprod(curv_sal[(x-19):96])*sal_prom
    enteros <- round(n_cot - n_cot[1])
    cantidades <- enteros[-1] - enteros[-length(enteros)]
    sal_pen <- rep(0, 115-x)
    sal_pen[1] <- salarios[1]
    cuotas <- unlist(cuotas_past*niveles)
    cuotas <- cuotas[cuotas>10000]
    if(sal_prom == 0){ # supone que ya no va a trabajar?
      pensiones[[id]] <- rep(mean(head(sort(
        cuotas[sum(1 - cuotas < 5e6)/enteros[i+1] > 0.5 | cuotas < 5e6],
        decreasing = T), 300)), 115-x)
      next
    }
    for(i in 1:(114-x)){
      cuotas <- c(cuotas, rep(salarios[i+1], cantidades[i]))
      calc_pen <- cuotas[sum(1 - cuotas < 5e6)/enteros[i+1] > 0.5 | cuotas < 5e6]
      sal_pen[i+1] <- mean(head(sort(calc_pen, decreasing = T), 300))
    }
    porc <- c(0.525,0.51, 0.494, 0.478, 0.462, 0.446, 0.43)
    montos <- c(2,3,4,5,6,8) * 367108.55
    indices <- findInterval(sal_pen, montos) + 1
    sal_pen <- sal_pen * porc[indices]
    pensiones[[id]] <- sal_pen
  }

  return(pensiones)
}
```


### Precálculo de las pensiones
```{r}
system.time(pensiones <- sal_pen())
```

### Obtención del interés
```{r}
hoja <- BD_Financiero[[3]]
int_mes <- sapply(1:120, function(x)  (hoja[x+1, 2] - hoja[x,2] - hoja[x,4] + hoja[x,5])/(hoja[x,2] + (hoja[x,4] - hoja[x,5])/2)+1)
int_mes <- unlist(int_mes)
int <- sapply(1:109, function(x) prod(int_mes[x:(11+x)])-1)
plot(int)
lines((0:109)*-0.0003859 + 0.177)
```

```{r}
inf_max <- IPC$Nivel[564]/IPC$Nivel[552] - 1
(int_real <- mean(int) - inf_max)
```

```{r}
rm(BD_Cotizantes,
   BD_Pensionados,
   BD_Financiero,
   poblacion, 
   IPC, 
   cuentas, 
   cot_prop,
   curva_sal,
   curva_dens, 
   SUPEN,
   unicos, 
   find_qx, 
   hoja,
   int, 
   inf_max, 
   int_mes, 
   sal_pen
   )
```

# Balance Actuarial
## Cálculo del VP de beneficios de pensiones futuras
```{r}
t <- proc.time()
datos <- vp_pen_futuras(int_real, 0.02)/1e9 
proc.time() - t
```

```{r}
colSums(datos)
```


# Segundo modelo deterministico
## Objetivo
calcular las pensiones por anualidades de mortalidad, en la función traerlas a vp
```{r}
source("cod/anualidades.R")
```

## Precálculo de los qx
```{r}
pc_qx <- function(){
    w <- 115
  difsex <- list()
  for(sex in 1:2){
    tqx <- list()
    for(x in 20:w){
      res <- (w-x)
      qx <- sapply(1:res, function(y) all_qx[[sex]][x+y, y])
      tqx[[x-19]] <- qx
    }
    difsex[[sex]] <- tqx
  }
  return(difsex)
}
```

```{r}
qx <- pc_qx()
```


## Cálculo con pensiones precalculadas
### Función para leer sumas de columnas de matrices triangulares
```{r}
readt <- function(mat){
  return(sapply(1:ncol(mat), function(x) sum(mat[1:x,x])))
}
```

```{r}
source("cod/vp_pen_fut.R")
```

```{r}
t <- proc.time()
datos2 <- vp_pen_fut(int_real, 0.02)/1e9
proc.time() - t
```

```{r}
rowSums(datos2)
```

# Modelo estocástico
Resultados similares pero diferentes -> Modelo estocástico

```{r}
curva_densidad$media <- curva_densidad$media/12
curva_densidad$std <- curva_densidad$std/12
```

```{r}
cotizaciones <- cotizaciones*niveles
```

```{r}
cuotas <- list()
for(i in 1:5196){
  cuotas[[i]] <- sapply(27:30, function(x) sum(cotizaciones[i,1:12+(12*(x-1))] > 1e4))
}
```

```{r}
oqx <- sapply(0:24, function(x)
  sapply(x:24, function(y)
    (all_qx[[1]][y+1,y-x+1] + all_qx[[2]][y+1,y-x+1])/2
    )
  )
```


```{r}
proy_est <- function(int, inf){
  v <- (1+inf)/(1+int)
  porc <- c(0.525,0.51, 0.494, 0.478, 0.462, 0.446, 0.43)
  montos <- c(2,3,4,5,6,8) * 367108.55
  res <- data.frame(Inv = 0, Pen = 0, Suc = 0, SEM = 0, 
                    InvF = rep(0, 96), PenF = 0, SucF = 0,SEMF = 0, CotAct = 0, CotPen = 0)
  anual <- (1-v)/(v^(-1/12)-1)
  anmag <- (anual + v^(11/12)) 
  min_inv <- sapply(20:115, function(x) cot_min_inv(x))
  for(id in 1:5561){
    cond_hij <- F
    cond_viu <- F
    cot_pen <- 0
    if(id <= 5196){
      cuotash <- cuotas[[id]]
      cuota <- cotizantes$cuotas[id]
      sexo <- cotizantes$sexo[id]
      x <- cotizantes$edad[id]
      salario <- cotizantes$sal_prom[id] 
      estado <- 0
      px <- 1-qx[[sexo]][[x - 19]]
      vpx <- 1-qx[[3-sexo]][[x - 19]]
      pix <- 1-all_qix[[sexo]][(x-19):96]
      cuotash <- c(cuotash, rep(0, 100))
      salariosh <- unlist(cotizaciones[id,])
      first_pen <- T
      roll_pen <- F
      porc_pen <- 1
    } else {
      if(id == 5197){
        res$InvF <- res$Inv
        res$PenF <- res$Pen
        res$SucF <- res$Suc
        res$SEMF <- res$SEM
        res$Inv <- 0
        res$Pen <- 0
        res$Suc <- 0
        res$SEM <- 0
      }
      i <- id - 5196
      x <- pensionados$edad[i]
      sexo <- pensionados$sexo[i]
      sal_pen <- pensionados$MONTO[i]*anmag
      tipo <- pensionados$COD_TIPO_PENSION[i]

      if(tipo == "Invalidez"){
        estado <- 2        
        px <- 1-qx[[sexo]][[x - 19]]
        vpx <- 1-qx[[3-sexo]][[x - 19]]
      } else if(tipo == "Vejez"){
        estado <- 1
        px <- 1-qx[[sexo]][[x - 19]]
        vpx <- 1-qx[[3-sexo]][[x - 19]]
      } else {
        estado <- 3
        if(pensionados$COD_PARENTESCO[i] == "H"){
          if(x >= 25){
            next
          }
          cond_hij <- T      
          opx <- 1 - oqx[[x+1]]
          c <- 0
          x <- x + 25
        } else {
          cond_viu <- T
          vpx <- 1-qx[[sexo]][[x - 19]]
        }
      }
    }
    
    for(j in 1:(115-x)){
      if(estado == 0){ # Trabaja
        if(runif(1) > px[j]){ # Muerte directa
          if(cuota >= 180 | sum(cuotash[(j+2):(j+3)])>=12){ # Solo si aplica
            estado <- 3
            cond_viu <- T
            if(x+j-25 >=0 & x+j-25 <25){
              cond_hij <- T
              c <- j-1
              opx <- 1 - oqx[[x+j-24]]
            }
          } else { # no hay sobrevivientes ni pensión alguna
            break
          }
          
        } else if(runif(1)>pix[j]){ # Invalidez
          if(cuotash[j+1] >= 180){
            estado <- 2
          } else if(x + j-1 < 48 & sum(cuotash[(j+2):(j+3)])>=12 & cuota > min_inv[x+j-20]){
            estado <- 2
          } else if(x + j-1 >= 48 & sum(cuotash[j:(j+3)])>=24 & cuota > min_inv[x+j-20]){
            estado <- 2
          } else if(cuota >= 60 & (sum(cuotash[(j+2):(j+3)])>=12|sum(cuotash[j:(j+3)])>=24)){
            estado <- 2
            porc_pen <- cuota/180
          } else { # No hay pensión ni sucesoria, gracias por aportar
            break
          }
        } else { # sobrevive, e invalidez > retiro
          prob_cot <- min(max(0, rnorm(1, 
                  curva_densidad$media[x+j-20], curva_densidad$std[x+j-20])),1)
          cuotash[j+5] <- rbinom(1, 12, prob_cot) 
          cuota <- cuota + cuotash[j+5]
          salario <- salario*max(0,rnorm(1, curva_salarial$s_x[x+j-20],
                                         curva_salarial$std[x+j-20]))
          salariosh <- c(salariosh, rep(salario, cuotash[j+5]))
          res$CotAct[j] <- res$CotAct[j] + 0.15*cuotash[j+5]*salario # cotizaciones
          if(x+j-1 >= 65 & cuota >= 300){
            roll_pen <- T
          } else if (sexo == 2 & x+j-1 == 64 & cuota >= 357){
            roll_pen <- T
          } else if (sexo == 2 & x+j-1 == 63 & cuota >= 405){
            roll_pen <- T
          } else if (x+j-1 >= 65 & cuota >= 180 & runif(1) <= 0.9){
            estado <- 1
            porc_pen <- cuota/300
          }
          if(roll_pen){ # para ver si se retira
            roll_pen <- F
            if(first_pen){
              first_pen <- F
              ini_pen <- cuota
            }
            if(runif(1) <= 0.9){
              estado <- 1
              porc_pen <- min(1.25, 1 + (cuota-ini_pen)*2/1500 + (ini_pen-300)/1200)
            }
          }
        }
        if(estado == 1 | estado == 2 | estado == 3){
          # Se acaba justo de cambiar y hay que calcular la pensión
          cot5m <- T
          salariosh <- salariosh*(1+inf)^(1/12*c(rep(0, 360),  -6 - 12*rep(0:(j-1),cuotash[6:(j+5)])))
          if(sum(salariosh > 5e6)/length(salariosh)<0.5){ # histórico 5 millones
            cot5m <- !salariosh > 5e6
          }
          salariosh <- salariosh[salariosh > 10000 & cot5m]
          sal_pen <- mean(head(sort(salariosh),300))
          if(is.na(sal_pen)){
            break
          }
          sal_pen <-  sal_pen*porc[findInterval(sal_pen, montos) + 1]*porc_pen 
          if(sal_pen > 2e6){
            cot_pen <- sal_pen*0.05
            sal_pen <- sal_pen*0.95
          } 
          if(sal_pen > 3.5e6){
            cot_pen <- cot_pen + sal_pen - 3.5e6
            sal_pen <- 3.5e6
          }
          sal_pen <- anmag*sal_pen 
          cot_pen <- anmag*cot_pen
          if(estado == 1){
            res$Pen[j] <- res$Pen[j] + sal_pen
            res$CotPen[j] <- res$CotPen[j] + cot_pen
          } else if(estado == 2) {
            res$Inv[j] <- res$Inv[j] + sal_pen 
            res$CotPen[j] <- res$CotPen[j] + cot_pen
          }
        }
      } else if(estado == 1 | estado == 2){ # Pensionado
        if(runif(1) > px[j]){ # Muerte directa. Como ya está pensionado si recibe
          estado <- 3
          cond_viu <- T
          if(x+j-25 >=0 & x+j-25 <25){
            cond_hij <- T
            c <- j-1
            opx <- 1 - oqx[[x+j-24]]
          }
        }
        # sigue un pago más
        if(estado == 1){
          res$Pen[j] <- res$Pen[j] + sal_pen
          res$CotPen[j] <- res$CotPen[j] + cot_pen
        } else if(estado == 2) {
          res$Inv[j] <- res$Inv[j] + sal_pen 
          res$CotPen[j] <- res$CotPen[j] + cot_pen
        }
      }
      if(estado == 3){ # Muerto, considerando reciente
        if(cond_hij){ # si hay un hijo
          if(x+j-25 >= 24){ # si ya creció y pasó los 25 años
            cond_hij <- F # ya no más pensión
          }
          if(runif(1) > opx[j-c]){ # se muere el hijo
            cond_hij <- F
          } else {
            res$Suc[j] <- res$Suc[j] + sal_pen*0.3
            res$CotPen[j] <- res$CotPen[j] + cot_pen*0.3
          }
        }
        if(cond_viu){
          if(runif(1) < vpx[j]){
            if(x+j-1 < 50){
              res$Suc[j] <- res$Suc[j] + sal_pen*0.5
              res$CotPen[j] <- res$CotPen[j] + cot_pen*0.5
            } else if(x+j-1 < 60){
              res$Suc[j] <- res$Suc[j] + sal_pen*0.6
              res$CotPen[j] <- res$CotPen[j] + cot_pen*0.6
            } else {
              res$Suc[j] <- res$Suc[j] + sal_pen*0.7
              res$CotPen[j] <- res$CotPen[j] + cot_pen*0.7
            }
          } else {
            cond_viu <- F # se muere el cónyuge
          }
        }
      }
    } 
  }
  res <- res*v^(-1/2)*v^(1:96)
  res$SEM <- (res$Inv + res$Pen + res$Suc)*anual/anmag*0.085
  res$SEMF <- (res$InvF + res$PenF + res$SucF)*anual/anmag*0.085
  return(res)
}
```

```{r}
t <- proc.time()
est <- proy_est(int_real, 0.02)
proc.time()-t
```

```{r}
colSums(est)/1e9
```

## Paralelización
```{r}
variables <- c("cotizantes", "cotizaciones", "qx", "all_qix", "int_real", "proy_est", "cot_min_inv", "cuotas", "curva_densidad", "curva_salarial", "oqx", "pensionados")
proy_est_par <- function(n, cores) {
  # Crear un clúster seguro
  cl <- makeCluster(cores) #min(detectCores()/2,
  # Exportar las variables necesarias al clúster
  clusterExport(
    cl,
    varlist = variables,
    envir = environment()
  )
  # Ejecutar la proyección en paralelo
  resultados <- parSapply(cl, 1:n, function(x) {
    proy_est(int_real, 0.02)
  })
  # Detener el clúster después de la ejecución
  stopCluster(cl)
  return(resultados)
}
```

```{r}
n <- 1000
# system.time(proyecciones <- proy_est_par(n, 4))
# copia <- lapply(1:n, function(x) as.data.frame(proyecciones[,x]))
# write.csv(copia, "res/datos.csv")
```

```{r}
proyecciones <- read.csv("res/datos.csv")
proyecciones <- proyecciones %>% select(-1)
proyecciones <- lapply(1:1000, function(x) proyecciones[,1:10 + 10*(x-1)])
```


```{r}
sumas <- sapply(1:n, function(x) colSums(as.data.frame(proyecciones[[x]])))
(media <- sapply(1:10, function(y) mean(sumas[y,]))/1e9)[1:9]
```

```{r}

```


## Convergencia 
```{r}
sum((media*1000 + colSums(est)/1e9)/1001/media)/10
```


```{r}
# IMPORTANTE: ninguna pensión sobrepasa los 2 millones
pensiones_actuales <- function(int, inf){
  v <- (1+inf)/(1+int)
  anual <- (1-v)/(v^(-1/12)-1)
  anmag <- (anual + v^(11/12)) 
  res <- data.frame(Inv = rep(0, 96), Pen = 0, Suc = 0, SEM = 0)
  for(id in 1:365){
    x <- pensionados$edad[id]
    sexo <- pensionados$sexo[id]
    tipo <- pensionados$COD_TIPO_PENSION[id]
    vp_pen <- pensionados$MONTO[id]*anmag
    if(tipo == "Invalidez" | tipo == "Vejez"){ # pension regular

      aqx <- qx[[sexo]][[x-19]]
      tpx <- c(1,cumprod(1-aqx))
      aqx <- c(aqx,1)
      if(tipo == "Invalidez" ){
        res$Inv <- res$Inv + c(tpx*vp_pen,rep(0, 95-(115-x)))
      } else {
        res$Pen <- res$Pen + c(tpx*vp_pen,rep(0, 95-(115-x)))
      }
      # viudez y orfandad

      res$Suc <- res$Suc + c(readt(viu[[3-sexo]][[x-19]]*tpx*aqx)*vp_pen,rep(0, 95-(115-x)))
      if(x < 50){

        res$Suc <- res$Suc + c(readt(orf[[x-19]]*tpx*aqx)*vp_pen,rep(0, 95-(115-x)))        
      }

    } else {
      if(pensionados$COD_PARENTESCO[id] == "H"){
        if(x >= 25){ # ya no más pensión
          next
        }
        res$Suc <- res$Suc + c(cumprod(1-oqx[[x+1]])*vp_pen, rep(0, 96-(25-x)))
      } else {
        res$Suc <- res$Suc + c(cumprod(1-qx[[sexo]][[x-20]])*vp_pen, rep(0, 95-(115-x)))
      }
    }
  }
  res$SEM <- (res$Inv + res$Pen + res$Suc)*anual/(anual+v^(11/12))*0.085
  return(res*v^(1:95))
}
```

```{r}
pen_act <- pensiones_actuales(int_real, 0.02)
```

```{r}
colSums(pen_act)/1e9
```





















